<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì¼€ë Œë””ì•„ ì ìš© ì—¬ë¶€ íŒë‹¨ ê³„ì‚°ê¸°</title>

  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#4f46e5;
      --primary2:#4338ca;
      --border:#e5e7eb;
      --okbg:#ecfdf5; --ok:#065f46;
      --nobg:#fef2f2; --no:#991b1b;
      --shadow: 0 10px 30px rgba(17,24,39,0.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, #eef2ff, transparent),
                  radial-gradient(1200px 600px at 90% 20%, #e0f2fe, transparent),
                  var(--bg);
      color:var(--text);
    }

    /* Header */
    .header{
      position: sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(246,248,255,0.75);
      border-bottom: 1px solid rgba(229,231,235,0.7);
      z-index: 10;
    }
    .header-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .logo{
      width:36px; height:36px;
      border-radius: 12px;
      background: linear-gradient(135deg, #4f46e5, #22c55e);
      box-shadow: 0 8px 20px rgba(79,70,229,0.25);
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
      font-weight: 600;
      white-space:nowrap;
    }

    /* Layout */
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }
    .hero{
      margin: 14px 0 18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .hero h1{
      margin:0;
      font-size: 28px;
      letter-spacing:-0.6px;
      line-height:1.2;
      font-weight: 900;
    }
    .hero p{
      margin:8px 0 0;
      color:var(--muted);
      font-size: 14px;
      max-width: 720px;
      line-height: 1.55;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid rgba(229,231,235,0.8);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(229,231,235,0.75);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(79,70,229,0.06), rgba(255,255,255,0));
    }
    .card-title{
      font-size: 16px;
      font-weight: 900;
      letter-spacing:-0.2px;
      margin:0;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,0.9);
      color: var(--muted);
      background: rgba(255,255,255,0.7);
      white-space:nowrap;
      font-weight: 700;
    }
    .card-body{ padding: 18px; }

    /* Form */
    .section{ margin-bottom: 16px; }
    .section h2{
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 900;
      color:#374151;
      letter-spacing:-0.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }

    label{
      display:block;
      font-size: 12px;
      color: #374151;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .field{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      outline:none;
      transition: box-shadow .15s, border-color .15s;
      font-size: 14px;
    }
    .field:focus{
      border-color: rgba(79,70,229,0.6);
      box-shadow: 0 0 0 4px rgba(79,70,229,0.12);
    }
    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
    }

    .btn{
      width:100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color:#fff;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      transition: transform .06s, background .15s, opacity .15s;
    }
    .btn:hover{ background: var(--primary2); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: 0.5; cursor:not-allowed; }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn-secondary{ background:#111827; }
    .btn-secondary:hover{ background:#0b1220; }
    .btn-ghost{
      background: #ffffff;
      color: #111827;
      border: 1px solid rgba(229,231,235,0.95);
    }
    .btn-ghost:hover{ background:#f9fafb; }

    .small-actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 560px){ .small-actions{ grid-template-columns:1fr; } }

    /* Result */
    .resultBox{
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,0.9);
      background: #fff;
    }
    .status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .status h3{
      margin:0;
      font-size: 18px;
      letter-spacing:-0.4px;
      font-weight: 900;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,0.08);
      white-space:nowrap;
    }
    .pill.ok{ background: var(--okbg); color: var(--ok); }
    .pill.no{ background: var(--nobg); color: var(--no); }

    .kpi{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .kpiItem{
      background:#f9fafb;
      border: 1px solid rgba(229,231,235,0.9);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .kpiLabel{ font-size: 12px; color: var(--muted); margin: 0 0 4px; font-weight: 800; }
    .kpiValue{ font-size: 22px; font-weight: 900; margin:0; letter-spacing:-0.4px; }

    .list{
      margin: 10px 0 0;
      padding-left: 18px;
      color:#374151;
      font-size: 13px;
      line-height:1.65;
      font-weight: 600;
    }
    .footnote{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.65;
      font-weight: 600;
      white-space: pre-line;
    }

    .hr{
      height: 1px;
      background: rgba(229,231,235,0.9);
      margin: 16px 0;
    }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid rgba(229,231,235,0.9);
      display:none;
    }
    .toast.show{ display:block; }
    .toast.ok{ background: var(--okbg); color: var(--ok); }
    .toast.no{ background: var(--nobg); color: var(--no); }

    /* Modal (ì¹˜ë£Œ í›„ê¸° ì´ë¯¸ì§€ íŒì—…) */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(920px, 96vw);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow:hidden;
      border: 1px solid rgba(229,231,235,0.8);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(229,231,235,0.85);
      background: linear-gradient(180deg, rgba(79,70,229,0.08), rgba(255,255,255,0));
    }
    .modalTitle{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .modalClose{
      border: none;
      background:#111827;
      color:#fff;
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .modalBody{
      padding: 14px 16px 18px;
    }
    .modalBody img{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,0.9);
      background:#f9fafb;
    }
    .modalHint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      font-weight: 600;
      white-space: pre-line;
    }

    /* Print only summary */
    #printArea{ display:none; }

    @media print{
      body{ background:#fff; }
      .header, .wrap{ display:none !important; }
      #printArea{
        display:block !important;
        padding: 16mm;
        font-family:"Noto Sans KR", Arial, sans-serif;
        color:#111827;
      }
      .printCard{
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 14px 14px;
      }
      .printTitle{
        font-size: 18px;
        font-weight: 900;
        margin: 0 0 8px;
      }
      .printMeta{
        font-size: 12px;
        color:#374151;
        margin: 0 0 10px;
        line-height: 1.6;
        white-space: pre-line;
      }
      .printSectionTitle{
        font-size: 13px;
        font-weight: 900;
        margin: 12px 0 6px;
      }
      .printText{
        font-size: 12px;
        line-height: 1.75;
        margin: 0;
        white-space: pre-line;
      }
      .printList{
        margin: 6px 0 0;
        padding-left: 18px;
        font-size: 12px;
        line-height: 1.75;
      }
      .printHr{
        height:1px;
        background:#e5e7eb;
        margin: 12px 0;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div>Kerendia Eligibility</div>
        <div class="sub">ë‹¨ì¼ HTML ë°ëª¨(ë¡œì»¬ ì‹¤í–‰)</div>
      </div>
    </div>
    <div class="sub">v1.1</div>
  </div>
</header>

<main class="wrap">
  <div class="hero">
    <div>
      <h1>ì¼€ë Œë””ì•„ ì ìš© ì—¬ë¶€ íŒë‹¨ ê³„ì‚°ê¸°</h1>
      <p>ì…ë ¥ê°’ìœ¼ë¡œ eGFRì„ ê³„ì‚°í•˜ê³ , ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ë¥¼ ìš”ì•½í•©ë‹ˆë‹¤. (ë‚´ë¶€ ê²€í† /ì„¤ëª…ìš© UI ë°ëª¨)</p>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: FORM -->
    <section class="card">
      <div class="card-head">
        <h2 class="card-title">ì…ë ¥</h2>
        <span class="badge">í•„ìˆ˜ ì…ë ¥ í›„ íŒì •</span>
      </div>
      <div class="card-body">
        <div class="section">
          <h2>ê¸°ë³¸ ì •ë³´</h2>
          <div class="row">
            <div>
              <label>ì„±ë³„</label>
              <select class="field" id="gender">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="male">ë‚¨ì„±</option>
                <option value="female">ì—¬ì„±</option>
              </select>
            </div>
            <div>
              <label>ë‚˜ì´</label>
              <input class="field" type="number" id="age" placeholder="ì˜ˆ: 60" min="0">
              <div class="hint">ì •ìˆ˜ ì…ë ¥ ê¶Œì¥</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>ê²€ì‚¬ ìˆ˜ì¹˜</h2>
          <div class="row">
            <div>
              <label>í˜ˆì²­ í¬ë ˆì•„í‹°ë‹Œ (mg/dL)</label>
              <input class="field" type="number" id="creatinine" step="0.1" placeholder="ì˜ˆ: 1.2">
            </div>
            <div>
              <label>ì¹¼ë¥¨ (mmol/L)</label>
              <input class="field" type="number" id="potassium" step="0.1" placeholder="ì˜ˆ: 4.5">
            </div>
          </div>
        </div>

        <div class="section">
          <h2>ë‹¨ë°±ë‡¨/ì•Œë¶€ë¯¼ë‡¨</h2>
          <div class="row">
            <div>
              <label>ê²€ì‚¬ ë°©ë²•</label>
              <select class="field" id="proteinTest" onchange="toggleProteinInputs()">
                <option value="dipstick">ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ (Dipstick)</option>
                <option value="uacr">uACR (mg/g)</option>
              </select>
            </div>

            <div id="dipstickWrap">
              <label>Dipstick ê²°ê³¼</label>
              <select class="field" id="dipstick">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="negative">ìŒì„± (-)</option>
                <option value="trace">ì•½ì–‘ì„± (Â±)</option>
                <option value="1plus">1+</option>
                <option value="2plus">2+</option>
                <option value="3plus">3+</option>
              </select>
            </div>

            <div id="uacrWrap" style="display:none;">
              <label>uACR (mg/g)</label>
              <input class="field" type="number" id="uacr" step="0.1" placeholder="ì˜ˆ: 350">
            </div>
          </div>
          <div class="hint">Dipstickì€ 1+ ì´ìƒ, uACRì€ 300 mg/g ì´ˆê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•©ë‹ˆë‹¤.</div>
        </div>

        <div class="section">
          <h2>ì¶”ê°€ ì¡°ê±´</h2>
          <div class="row">
            <div>
              <label>ì œ2í˜• ë‹¹ë‡¨ë³‘</label>
              <select class="field" id="diabetes">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>
            </div>
            <div>
              <label>ACEì–µì œì œ/ARB 4ì£¼ ì´ìƒ</label>
              <select class="field" id="aceArb">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label>ë§Œì„± ì‹¬ë¶€ì „ (NYHA II~IV)</label>
              <select class="field" id="heartFailure">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>
            </div>
          </div>
        </div>

        <button class="btn" onclick="handleSubmit()">íŒì • ê²°ê³¼ í™•ì¸</button>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetAll()">ìƒˆë¡œìš´ ê²€ì‚¬</button>
          <button class="btn btn-ghost" onclick="window.print()">ì „ì²´ í™”ë©´ ì¸ì‡„</button>
        </div>

        <div class="footnote">
* ì´ í˜ì´ì§€ëŠ” ë‹¨ì¼ HTML ë°ëª¨ì…ë‹ˆë‹¤.
* ì‹¤ì œ ì ìš©/ì²­êµ¬/ì²˜ë°© íŒë‹¨ì€ ê¸°ê´€ ê¸°ì¤€ ë° ê³µì‹ ë¬¸ì„œë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
        </div>
      </div>
    </section>

    <!-- RIGHT: RESULT -->
    <aside class="card">
      <div class="card-head">
        <h2 class="card-title">ê²°ê³¼</h2>
        <span class="badge">ìš”ì•½/ë³µì‚¬/PDF</span>
      </div>
      <div class="card-body">
        <div id="result" class="resultBox">
          <div class="status">
            <h3>ëŒ€ê¸° ì¤‘</h3>
            <span class="pill">ì…ë ¥ í›„ íŒì •</span>
          </div>
          <div class="hr"></div>
          <div class="footnote">ì¢Œì¸¡ í•­ëª©ì„ ì…ë ¥í•œ ë’¤ â€œíŒì • ê²°ê³¼ í™•ì¸â€ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <!-- ë³µì‚¬/í”„ë¦°íŠ¸/í›„ê¸° ë²„íŠ¼ ì˜ì—­(ê²°ê³¼ ë‚˜ì™”ì„ ë•Œ í™œì„±í™”) -->
        <div class="small-actions" style="margin-top:12px;">
          <button class="btn btn-ghost" id="btnReview" onclick="openReviewModal()" disabled>ì¹˜ë£Œ í›„ê¸° ë³´ê¸°</button>
          <button class="btn btn-ghost" id="btnCopy" onclick="copySummary()" disabled>ìš”ì•½ë¬¸ ë³µì‚¬</button>
          <button class="btn" id="btnPdf" onclick="printSummaryOnly()" disabled>ìš”ì•½ë¬¸ PDF/í”„ë¦°íŠ¸</button>
        </div>

        <div id="toast" class="toast"></div>
      </div>
    </aside>
  </div>
</main>

<!-- ì¹˜ë£Œ í›„ê¸° íŒì—…(ëª¨ë‹¬) -->
<div id="modalOverlay" class="modalOverlay" onclick="closeReviewModal(event)">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" onclick="event.stopPropagation()">
    <div class="modalHead">
      <h3 id="modalTitle" class="modalTitle">ì¹˜ë£Œ í›„ê¸°</h3>
      <button class="modalClose" onclick="closeReviewModal()">ë‹«ê¸°</button>
    </div>
    <div class="modalBody">
      <!-- âœ… ì—¬ê¸° src íŒŒì¼ëª…ì„ ë°”ê¾¸ë©´ ë¨. ê°™ì€ í´ë”ì— ì´ë¯¸ì§€ íŒŒì¼ì„ ë‘ì„¸ìš”. -->
      <img id="reviewImg" src="treatment_review.png" alt="ì¹˜ë£Œ í›„ê¸° ì´ë¯¸ì§€">
      <div class="modalHint">
- ì´ë¯¸ì§€ê°€ ì•ˆ ë³´ì´ë©´: ì´ HTML íŒŒì¼ê³¼ ê°™ì€ í´ë”ì— "treatment_review.png"ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
- íŒŒì¼ëª…ì´ ë‹¤ë¥´ë©´: ìœ„ img íƒœê·¸ì˜ src="..."ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<!-- ìš”ì•½ë¬¸ë§Œ í”„ë¦°íŠ¸ìš© ì˜ì—­(í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
<div id="printArea">
  <div class="printCard">
    <div class="printTitle">ì¼€ë Œë””ì•„ ì ìš© ì—¬ë¶€ íŒë‹¨ ìš”ì•½</div>
    <div id="printMeta" class="printMeta"></div>

    <div class="printHr"></div>

    <div class="printSectionTitle">ìš”ì•½ë¬¸</div>
    <p id="printSummary" class="printText"></p>

    <div class="printHr"></div>

    <div class="printSectionTitle">í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­</div>
    <p class="printText" id="printPrecautions"></p>
  </div>
</div>

<script>
  const el = (id) => document.getElementById(id);
  let lastResult = null; // ê²°ê³¼ ì €ì¥(ìš”ì•½/ë³µì‚¬/í”„ë¦°íŠ¸ì— ì‚¬ìš©)

  const PRECAUTIONS_TEXT =
`í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­:
- ì¼€ë Œë””ì•„(Finerenone)ëŠ” ì‹ ì¥ ë³´í˜¸ ë° ì‹¬í˜ˆê´€ ì§ˆí™˜ ì˜ˆë°©ì„ ìœ„í•œ ì•½ì œë¡œ,
  2í˜• ë‹¹ë‡¨ë³‘ê³¼ ë§Œì„±ì‹ ì¥ë³‘(CKD) í™˜ìì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

- ë³µìš© ì¤‘ ê³ ì¹¼ë¥¨í˜ˆì¦ì˜ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
- ê³ ì¹¼ë¥¨í˜ˆì¦ ì¦ìƒ: ê·¼ìœ¡ ì•½í™”, í”¼ë¡œê°, ë¬´ê¸°ë ¥, ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê±°ë‚˜ ëŠë ¤ì§€ëŠ” ëŠë‚Œ(ë¶€ì •ë§¥)
  ì´ëŸ¬í•œ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ë©´ ì¦‰ì‹œ ì˜ë£Œì§„ì—ê²Œ ì•Œë¦¬ì‹­ì‹œì˜¤.
- ê³ í˜ˆì••ì•½(RAASì–µì œì œ)ê³¼ ë³‘ìš© ì‹œ ì „í•´ì§ˆ ì´ìƒì„ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•©ë‹ˆë‹¤.
- ì´ìƒ ì¦ìƒ ì‹œ ì¦‰ì‹œ ì˜ë£Œì§„ì— ìƒë‹´í•˜ì„¸ìš”.
- ì˜ì‚¬ ì§€ì‹œ ì—†ì´ ë³µìš©ì„ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì¦ëŸ‰í•˜ì§€ ë§ˆì„¸ìš”.

âœ” CKD í™˜ìëŠ” ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ë¡œ í˜ˆì¤‘ ì¹¼ë¥¨ ë†ë„ë¥¼ í™•ì¸í•˜ê³ , ì¹¼ë¥¨ ì„­ì·¨ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.

ğŸ½ ì¹¼ë¥¨ ì„­ì·¨ë¥¼ ì¤„ì´ëŠ” ë°©ë²•:
 1. ì•¼ì±„ëŠ” ë“ëŠ” ë¬¼ì— ë°ì¹˜ê¸° (ì±„ì†Œ ë¬´ê²Œì˜ 4~5ë°° ì´ìƒ ë¬¼ ì‚¬ìš©)
 2. ì–‡ê²Œ ì¬ í›„ ì°¬ë¬¼ì— 2ì‹œê°„ ë‹´ê°”ë‹¤ê°€ ë¬¼ì„ ë²„ë¦¬ê³  ì¡°ë¦¬
 3. ì±„ì†Œ ê»ì§ˆê³¼ ì¤„ê¸° ì œê±° í›„ ì„­ì·¨

âš ï¸ ì¹¼ë¥¨ì´ ë§ì€ ì‹í’ˆ ì£¼ì˜:
 - ê°ì, ê³ êµ¬ë§ˆ, í† ë§ˆí† , ë°”ë‚˜ë‚˜, í‚¤ìœ„, ë©œë¡ 
 - ì‹œê¸ˆì¹˜, ë¯¸ì—­, ë‹¤ì‹œë§ˆ, ì½©, ê²¬ê³¼ë¥˜
 - ì´ˆì½œë¦¿, ì»¤í”¼, ë‘ìœ , ì£¼ìŠ¤, ì¸ìŠ¤í„´íŠ¸êµ­, í™ì‚¼ì ¤ë¦¬ ë“±

ğŸ’§ ìˆ˜ë¶„ ì„­ì·¨ëŠ” ì‹ ì¥ ìƒíƒœì— ë”°ë¼ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì—¬ ê²°ì •í•˜ì„¸ìš”.
(ì¶œì²˜: CKD in T2D Awareness Symposium, Kerendia & ì¢…ê·¼ë‹¹)`;

  function toggleProteinInputs(){
    const mode = el('proteinTest').value;
    el('dipstickWrap').style.display = mode === 'dipstick' ? 'block' : 'none';
    el('uacrWrap').style.display = mode === 'uacr' ? 'block' : 'none';
  }

  function calculateEGFR(gender, age, creatinine) {
    const K = gender === 'male' ? 0.9 : 0.7;
    const alpha = gender === 'male' ? -0.302 : -0.241;
    const min = Math.min(creatinine / K, 1);
    const max = Math.max(creatinine / K, 1);
    let eGFR = 142 * Math.pow(min, alpha) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
    if (gender === 'female') eGFR *= 1.012;
    return Math.round(eGFR);
  }

  function handleSubmit(){
    const gender = el('gender').value;
    const age = parseInt(el('age').value, 10);
    const creatinine = parseFloat(el('creatinine').value);
    const potassium = parseFloat(el('potassium').value);
    const diabetes = el('diabetes').value;
    const aceArb = el('aceArb').value;
    const heartFailure = el('heartFailure').value;
    const proteinTest = el('proteinTest').value;
    const dipstick = el('dipstick').value;
    const uacrRaw = el('uacr').value;
    const uacr = uacrRaw === '' ? NaN : parseFloat(uacrRaw);

    // required validation
    let missing = [];
    if(!gender) missing.push('ì„±ë³„');
    if(!Number.isFinite(age)) missing.push('ë‚˜ì´');
    if(!Number.isFinite(creatinine)) missing.push('í¬ë ˆì•„í‹°ë‹Œ');
    if(!Number.isFinite(potassium)) missing.push('ì¹¼ë¥¨');
    if(!diabetes) missing.push('ë‹¹ë‡¨ë³‘ ì—¬ë¶€');
    if(!aceArb) missing.push('ACE/ARB');
    if(!heartFailure) missing.push('ì‹¬ë¶€ì „ ì—¬ë¶€');
    if(proteinTest === 'dipstick' && !dipstick) missing.push('Dipstick ê²°ê³¼');
    if(proteinTest === 'uacr' && !Number.isFinite(uacr)) missing.push('uACR');

    if(missing.length){
      lastResult = {
        eligible:false, eGFR:null, diseaseCode:'',
        reasons:[`í•„ìˆ˜ ì…ë ¥ ëˆ„ë½: ${missing.join(', ')}`],
        form:{
          gender, age, creatinine, potassium, proteinTest, dipstick, uacr: uacrRaw,
          diabetes, aceArb, heartFailure
        }
      };
      renderResult(lastResult);
      enableResultActions(true);
      showToast('í•„ìˆ˜ ì…ë ¥ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ìš”ì•½/ë³µì‚¬ ê¸°ëŠ¥ì€ ì‚¬ìš© ê°€ëŠ¥)', false);
      return;
    }

    const eGFR = calculateEGFR(gender, age, creatinine);

    let eligible = true;
    let reasons = [];
    let diseaseCode = '';

    if (diabetes !== 'yes') { eligible = false; reasons.push('ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ìê°€ ì•„ë‹™ë‹ˆë‹¤'); }
    if (aceArb !== 'yes') { eligible = false; reasons.push('ACEì–µì œì œ ë˜ëŠ” ARBë¥¼ 4ì£¼ ì´ìƒ íˆ¬ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'); }

    if (eGFR < 25) {
      eligible = false;
      reasons.push(`eGFRì´ ${eGFR}ë¡œ 25 ë¯¸ë§Œì…ë‹ˆë‹¤ (íˆ¬ì—¬ ì‹œì‘ ê¶Œì¥ ì•ˆë¨)`);
    } else if (eGFR >= 75) {
      eligible = false;
      reasons.push(`eGFRì´ ${eGFR}ë¡œ 75 ì´ìƒì…ë‹ˆë‹¤`);
    } else {
      if (eGFR >= 60 && eGFR < 75) diseaseCode = 'N182 (ë§Œì„±ì‹ ì¥ë³‘ 2ê¸°)';
      else if (eGFR >= 30 && eGFR < 60) diseaseCode = 'N183 (ë§Œì„±ì‹ ì¥ë³‘ 3ê¸°)';
      else if (eGFR >= 25 && eGFR < 30) diseaseCode = 'N184 (ë§Œì„±ì‹ ì¥ë³‘ 4ê¸°)';
    }

    if (proteinTest === 'dipstick') {
      if (dipstick === 'negative' || dipstick === 'trace') {
        eligible = false;
        reasons.push('ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ ê²°ê³¼ê°€ 1+ ë¯¸ë§Œì…ë‹ˆë‹¤');
      }
    } else {
      if (!Number.isFinite(uacr) || uacr <= 300) {
        eligible = false;
        reasons.push('uACRì´ 300 mg/g ì´í•˜ì…ë‹ˆë‹¤');
      }
    }

    if (potassium > 4.8) {
      eligible = false;
      reasons.push(`ì¹¼ë¥¨ ìˆ˜ì¹˜ê°€ ${potassium}ë¡œ 4.8 mmol/Lë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`);
    }

    if (heartFailure === 'yes') {
      eligible = false;
      reasons.push('ë§Œì„± ì‹¬ë¶€ì „(NYHA class II~IV) í™˜ìëŠ” ì œì™¸ë©ë‹ˆë‹¤');
    }

    lastResult = {
      eligible, eGFR, diseaseCode, reasons,
      form:{
        gender, age, creatinine, potassium, proteinTest, dipstick,
        uacr: (proteinTest === 'uacr') ? String(uacr) : '',
        diabetes, aceArb, heartFailure
      }
    };

    renderResult(lastResult);
    enableResultActions(true);
    showToast('ê²°ê³¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ìš”ì•½ ë³µì‚¬ / PDF/í”„ë¦°íŠ¸ ê°€ëŠ¥)', true);
  }

  function renderResult(res){
    const pillClass = res.eligible ? 'ok' : 'no';
    const title = res.eligible ? 'ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥' : 'ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€';

    let html = `
      <div class="status">
        <h3>${title}</h3>
        <span class="pill ${pillClass}">${res.eligible ? 'Eligible' : 'Not eligible'}</span>
      </div>
    `;

    html += `<div class="kpi">
      <div class="kpiItem">
        <p class="kpiLabel">ê³„ì‚°ëœ eGFR</p>
        <p class="kpiValue">${(res.eGFR ?? '-')}
          <span style="font-size:12px;color:var(--muted);font-weight:800;"> mL/min/1.73ã¡</span>
        </p>
      </div>
    </div>`;

    if(res.diseaseCode){
      html += `<div class="kpiItem" style="margin-top:10px;background:#eff6ff;">
        <p class="kpiLabel">ìƒë³‘ì½”ë“œ</p>
        <p style="margin:0;font-weight:900;color:#1e40af;">${escapeHtml(res.diseaseCode)}</p>
      </div>`;
    }

    // ìš”ì•½(ê²°ê³¼ ì˜ì—­ì—ë„ ì§§ê²Œ ë³´ì—¬ì£¼ê¸°)
    const summaryText = buildSummaryText(res);
    html += `<div class="kpiItem" style="margin-top:10px;">
      <p class="kpiLabel">ê²°ê³¼ ìš”ì•½</p>
      <p style="margin:0;font-size:13px;line-height:1.75;font-weight:700;white-space:pre-line;">${escapeHtml(summaryText)}</p>
    </div>`;

    if(!res.eligible && res.reasons && res.reasons.length){
      html += `<div class="kpiItem" style="margin-top:10px;background:var(--nobg);border-color: rgba(153,27,27,0.15);">
        <p class="kpiLabel" style="color:var(--no);font-weight:900;">ì ìš© ë¶ˆê°€ ì‚¬ìœ </p>
        <ul class="list">${res.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}</ul>
      </div>`;
    }

    if(res.eligible){
      html += `<div class="kpiItem" style="margin-top:10px;background:var(--okbg);border-color: rgba(6,95,70,0.12);">
        <p class="kpiLabel" style="color:var(--ok);font-weight:900;">ì ìš© ê¸°ì¤€ ì¶©ì¡±(ì²´í¬)</p>
        <ul class="list">
          <li>ì œ2í˜• ë‹¹ë‡¨ë³‘</li>
          <li>ACEì–µì œì œ ë˜ëŠ” ARB 4ì£¼ ì´ìƒ</li>
          <li>eGFR 25 ì´ìƒ 75 ë¯¸ë§Œ</li>
          <li>ë‹¨ë°±ë‡¨ ê¸°ì¤€ ì¶©ì¡±</li>
          <li>ì¹¼ë¥¨ 4.8 mmol/L ì´í•˜</li>
          <li>ë§Œì„± ì‹¬ë¶€ì „ ì—†ìŒ</li>
        </ul>
      </div>`;
    }

    html += `<div class="footnote">
* ë³¸ ê²°ê³¼ëŠ” ì…ë ¥ê°’ ê¸°ë°˜ì˜ ë‹¨ìˆœ íŒì •ì…ë‹ˆë‹¤.
* ì‹¤ì œ ì ìš©/ì²­êµ¬ëŠ” ê¸°ê´€ ê¸°ì¤€ ë° ê³µì‹ ë¬¸ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.
    </div>`;

    el('result').innerHTML = html;
  }

  function enableResultActions(enabled){
    el('btnReview').disabled = !enabled;
    el('btnCopy').disabled = !enabled;
    el('btnPdf').disabled = !enabled;
  }

  function resetAll(){
    ['gender','age','creatinine','potassium','dipstick','uacr','diabetes','aceArb','heartFailure'].forEach(id=>{
      if(el(id)) el(id).value = '';
    });
    el('proteinTest').value = 'dipstick';
    toggleProteinInputs();
    lastResult = null;
    enableResultActions(false);
    el('toast').className = 'toast';
    el('toast').textContent = '';

    el('result').innerHTML = `
      <div class="status">
        <h3>ëŒ€ê¸° ì¤‘</h3>
        <span class="pill">ì…ë ¥ í›„ íŒì •</span>
      </div>
      <div class="hr"></div>
      <div class="footnote">ì¢Œì¸¡ í•­ëª©ì„ ì…ë ¥í•œ ë’¤ â€œíŒì • ê²°ê³¼ í™•ì¸â€ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    `;
  }

  function buildSummaryText(res){
    // ì˜ì‚¬ê°€ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° í•˜ê¸° ì¢‹ì€ â€œì§§ê³  êµ¬ì¡°ì ì¸ ë¬¸ì¥â€
    const f = res.form || {};
    const sex = (f.gender === 'male') ? 'ë‚¨ì„±' : (f.gender === 'female' ? 'ì—¬ì„±' : '-');
    const proteinLine = (f.proteinTest === 'uacr')
      ? `ì•Œë¶€ë¯¼ë‡¨: uACR ${f.uacr || '-'} mg/g`
      : `ë‹¨ë°±ë‡¨: Dipstick ${mapDipstick(f.dipstick)}`;

    let lines = [];
    lines.push(`íŒì •: ${res.eligible ? 'ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥' : 'ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€'}`);
    lines.push(`eGFR: ${res.eGFR ?? '-'} mL/min/1.73ã¡${res.diseaseCode ? ` / ${res.diseaseCode}` : ''}`);
    lines.push(`ê¸°ë³¸: ${sex}, ${f.age || '-'}ì„¸ / Cr ${f.creatinine || '-'} mg/dL / K ${f.potassium || '-'} mmol/L`);
    lines.push(`${proteinLine}`);
    lines.push(`ì¡°ê±´: T2D ${yn(f.diabetes)} / ACEiÂ·ARB(â‰¥4ì£¼) ${yn(f.aceArb)} / ë§Œì„± ì‹¬ë¶€ì „ ${yn(f.heartFailure)}`);

    if(!res.eligible && res.reasons && res.reasons.length){
      // ë¶ˆê°€ ì‚¬ìœ ëŠ” 3ê°œê¹Œì§€ë§Œ ìš”ì•½(ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ” ê²ƒ ë°©ì§€)
      const top = res.reasons.slice(0, 3).map((r, i) => `${i+1}) ${r}`);
      lines.push(`ë¶ˆê°€ ì‚¬ìœ : ${top.join(' / ')}${res.reasons.length > 3 ? ` (+${res.reasons.length - 3}ê°œ)` : ''}`);
    }

    return lines.join('\n');
  }

  function yn(v){
    if(v === 'yes') return 'ì˜ˆ';
    if(v === 'no') return 'ì•„ë‹ˆì˜¤';
    return '-';
  }
  function mapDipstick(v){
    const m = {
      'negative':'ìŒì„±(-)',
      'trace':'ì•½ì–‘ì„±(Â±)',
      '1plus':'1+',
      '2plus':'2+',
      '3plus':'3+'
    };
    return m[v] || '-';
  }

  async function copySummary(){
    if(!lastResult){
      showToast('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒì •ì„ ì‹¤í–‰í•˜ì„¸ìš”.', false);
      return;
    }
    const text = buildSummaryText(lastResult);

    // Clipboard API + fallback
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
      } else {
        fallbackCopyText(text);
      }
      showToast('ìš”ì•½ë¬¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    } catch(e){
      fallbackCopyText(text);
      showToast('ìš”ì•½ë¬¸ ë³µì‚¬(ëŒ€ì²´ ë°©ì‹) ì™„ë£Œ. ì•ˆ ë˜ë©´ ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', true);
    }
  }

  function fallbackCopyText(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly','');
    ta.style.position = 'fixed';
    ta.style.top = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }

  function printSummaryOnly(){
    if(!lastResult){
      showToast('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒì •ì„ ì‹¤í–‰í•˜ì„¸ìš”.', false);
      return;
    }

    const now = new Date();
    const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    el('printMeta').textContent = `ìƒì„±ì¼ì‹œ: ${stamp}\në„êµ¬: ì¼€ë Œë””ì•„ ì ìš© ì—¬ë¶€ íŒë‹¨ ê³„ì‚°ê¸°(ë¡œì»¬ ë‹¨ì¼ HTML)`;
    el('printSummary').textContent = buildSummaryText(lastResult);
    el('printPrecautions').textContent = PRECAUTIONS_TEXT;

    window.print();
  }

  function showToast(msg, ok){
    const t = el('toast');
    t.textContent = msg;
    t.className = `toast show ${ok ? 'ok' : 'no'}`;
    setTimeout(()=>{ t.className = 'toast'; t.textContent = ''; }, 3200);
  }

  function openReviewModal(){
    // ì´ë¯¸ì§€ íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ ì •ìƒ í‘œì‹œë¨
    el('modalOverlay').classList.add('show');
  }

  function closeReviewModal(evt){
    // overlay í´ë¦­ ì‹œ ë‹«ê¸°
    if(evt && evt.target && evt.target.id !== 'modalOverlay') return;
    el('modalOverlay').classList.remove('show');
  }

  // ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      el('modalOverlay').classList.remove('show');
    }
  });

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // ì´ˆê¸° ìƒíƒœ
  enableResultActions(false);
</script>

</body>
</html>
