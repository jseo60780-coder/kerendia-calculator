<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>케렌디아 급여 적용 확인</title>

  <style>
    :root{
      --bg:#F9F3F5;
      --panel:#ffffff;
      --panel2:#F8F9FB;
      --brand:#D1005D;
      --brandSoft:#F2A2C1;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#E5E7EB;
      --shadow: 0 20px 60px rgba(0,0,0,0.08);
      --r1: 36px;
      --r2: 22px;
      --font: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --focus: 0 0 0 4px rgba(209,0,93,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 34px 18px 60px;
    }
    .wrap{width:100%; max-width: 1120px;}

    /* Top */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom: 16px;
    }
    .brand{display:flex; align-items:center; gap:14px;}
    .logo-img{height:42px; width:auto; display:block;}
    .title h1{margin:0; font-size:20px; font-weight:900; letter-spacing:-.02em;}
    .title p{margin:5px 0 0; font-size:11px; color:var(--muted);}
    .pill{
      font-size:11px; color:var(--brand);
      background:#fff; border:1px solid rgba(242,162,193,.95);
      padding: 8px 14px; border-radius: 999px; white-space:nowrap;
    }

    /* Stepper */
    .stepper{
      background:#fff;
      border-radius:999px;
      padding: 12px 36px;
      display:flex; justify-content:center; align-items:center; gap:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      margin-bottom: 22px;
    }
    .step{display:flex; align-items:center; gap:8px; font-size:13px; color:#b7b7b7;}
    .step .num{
      width:22px; height:22px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--line); background:#fff; font-size:11px;
    }
    .step.active{color:var(--brand); font-weight:900;}
    .step.active .num{background:var(--brand); color:#fff; border-color:var(--brand);}
    .line{width:44px; height:1px; background:#eee;}

    /* Shell */
    .shell{
      background: rgba(255,255,255,.72);
      border-radius: var(--r1);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.6);
    }

    /* Step0 card */
    .main-card{
      background: var(--panel);
      border-radius: var(--r1);
      overflow:hidden;
      display:flex;
      min-height: 560px;
    }
    .hero-visual{
      flex: 1.05;
      background: var(--panel2);
      display:flex; align-items:center; justify-content:center;
      padding: 42px;
    }
    .poster-card{
      background:#fff;
      border-radius: 26px;
      width:100%;
      max-width: 340px;
      padding: 26px 22px 20px;
      text-align:center;
      box-shadow: 0 14px 40px rgba(0,0,0,0.08);
    }
    .poster-card img{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      border-radius: 16px;
      margin:0 auto 16px;
    }
    .poster-strong{
      font-size:18px;
      font-weight:900;
      color:var(--brand);
      margin: 6px 0 6px;
    }
    .poster-soft{
      font-size:12px;
      font-weight:400;
      color:var(--muted);
      margin:0;
    }

    .hero-form{
      flex: 1;
      padding: 76px 64px;
      display:flex;
      flex-direction:column;
    }
    .hero-form h2{margin:0 0 10px; font-size:26px; font-weight:900;}
    .hero-form .sub{
      margin:0 0 34px;
      font-size:13px;
      color:var(--muted);
      line-height:1.6;
    }

    label{display:block; font-size:13px; font-weight:700; margin: 0 0 8px; color:#374151;}
    select,input{
      width:100%;
      padding: 15px 14px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:15px;
      margin-bottom: 22px;
      outline:none;
    }
    select:focus,input:focus{box-shadow:var(--focus); border-color: rgba(209,0,93,.35);}

    .btn{
      width:100%;
      padding: 18px;
      border-radius: 14px;
      border: none;
      font-size: 17px;
      font-weight: 900;
      color:#fff;
      background: var(--brandSoft);
      cursor: not-allowed;
      transition: .15s;
    }
    .btn.active{background: var(--brand); cursor:pointer;}
    .hint{margin:14px 0 0; font-size:12px; color:var(--muted);}

    /* Step1/2 */
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    .card{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius: var(--r2);
      padding: 18px;
      box-shadow: 0 12px 30px rgba(17,24,39,.06);
    }
    .card h3{margin:0 0 12px; font-size:16px;}
    .card h2{margin:0 0 12px; font-size:20px;}
    textarea{
      width:100%;
      min-height: 150px;
      padding: 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      outline:none;
      font-size: 13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      background:#fff;
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnRow{display:flex; gap:10px; margin-top:16px; flex-wrap:wrap;}
    .btnLite{
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      color:#111827;
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .btnPrimary{
      border:none;
      background: var(--brand);
      color:#fff;
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .btnPrimary:disabled{opacity:.45; cursor:not-allowed;}
    .badge{
      display:inline-flex;
      padding: 6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid transparent;
      margin-top: 6px;
    }
    .good{background:#ecfdf5; color:#065f46; border-color:#10b981;}
    .bad{background:#fef2f2; color:#991b1b; border-color:#ef4444;}

    /* pages */
    .page{display:none;}
    .page.active{display:block;}

    /* debug bar (에러가 있어도 화면에 표시) */
    .debug{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(229,231,235,.9);
      color: #6b7280;
      font-size: 12px;
      display:none;
    }
    .debug.show{display:block;}

    @media (max-width: 860px){
      .main-card{flex-direction:column;}
      .hero-visual{padding: 26px 18px;}
      .hero-form{padding: 36px 22px;}
      .grid{grid-template-columns:1fr;}
      .line{display:none;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="kerendia-logo-transparent.png" alt="Kerendia" class="logo-img">
        <div class="title">
          <h1>케렌디아 급여 적용 확인</h1>
          <p>CKD-EPI 2021 Equation 기반 eGFR 계산</p>
        </div>
      </div>
      <div class="pill">의료진 참고용</div>
    </div>

    <div class="stepper">
      <div class="step active" id="chip0"><span class="num">0</span> 시작</div>
      <div class="line"></div>
      <div class="step" id="chip1"><span class="num">1</span> 추가 입력</div>
      <div class="line"></div>
      <div class="step" id="chip2"><span class="num">2</span> 결과</div>
    </div>

    <div class="shell">
      <!-- STEP 0 -->
      <section id="step0" class="page active">
        <div class="main-card">
          <div class="hero-visual">
            <div class="poster-card">
              <img src="with-kerendia-hero-pink.png" alt="신장 캐릭터">
              <div class="poster-strong">급여 확인 계산기</div>
              <p class="poster-soft">케렌디아와 함께하는 신장 건강을</p>
            </div>
          </div>

          <!-- 폼 태그를 쓰되 submit 막고(중요), 엔터도 제어 -->
          <form class="hero-form" id="startForm" autocomplete="off">
            <h2>기본 정보 입력</h2>
            <p class="sub">
              먼저 성별과 나이만 입력하세요.<br>
              다음 단계에서 추가 검사 수치를 입력합니다.
            </p>

            <label for="gender0">성별</label>
            <select id="gender0" name="gender0" required>
              <option value="">선택하세요</option>
              <option value="male">남성</option>
              <option value="female">여성</option>
            </select>

            <label for="age0">나이</label>
            <input type="number" id="age0" name="age0" placeholder="예: 62" min="1" max="120" required />

            <!-- 반드시 type="button" (submit 방지 핵심) -->
            <button type="button" class="btn" id="goExtraBtn" disabled>급여대상 확인하기</button>
            <p class="hint" id="startHint">성별과 나이를 입력하면 다음 단계로 이동할 수 있어요.</p>

            <div id="debug" class="debug"></div>
          </form>
        </div>
      </section>

      <!-- STEP 1 -->
      <section id="step1" class="page">
        <div class="grid">
          <div class="card">
            <h3>기본 정보 (고정)</h3>
            <div class="row2">
              <div>
                <label>성별</label>
                <input id="genderFixed" readonly>
              </div>
              <div>
                <label>나이</label>
                <input id="ageFixed" readonly>
              </div>
            </div>

            <hr style="margin:18px 0; border:0; border-top:1px solid #eee">

            <h3>검사 수치</h3>

            <label>혈청 크레아티닌 (mg/dL)</label>
            <input id="creatinine" type="number" step="0.1" placeholder="예: 1.2">

            <label>칼륨 (mmol/L)</label>
            <input id="potassium" type="number" step="0.1" placeholder="예: 4.5">

            <div class="btnRow">
              <button type="button" class="btnLite" id="backTo0">이전으로</button>
            </div>
          </div>

          <div class="card">
            <h3>단백뇨 및 동반 질환</h3>

            <label>검사 방법</label>
            <select id="proteinTest">
              <option value="dipstick">Dipstick (요 시험지봉)</option>
              <option value="uacr">uACR (요알부민/크레아티닌비)</option>
            </select>

            <div id="dipstickWrap">
              <label>Dipstick 결과</label>
              <select id="dipstick">
                <option value="">선택하세요</option>
                <option value="negative">음성 (-)</option>
                <option value="1plus">1+</option>
                <option value="2plus">2+</option>
                <option value="3plus">3+</option>
              </select>
            </div>

            <div id="uacrWrap" style="display:none">
              <label>uACR (mg/g)</label>
              <input id="uacr" type="number" placeholder="예: 350">
            </div>

            <label>제2형 당뇨병 여부</label>
            <select id="diabetes">
              <option value="">선택하세요</option>
              <option value="yes">예</option>
              <option value="no">아니오</option>
            </select>

            <label>표준요법(ACE/ARB) 4주 이상 투여</label>
            <select id="aceArb">
              <option value="">선택하세요</option>
              <option value="yes">예</option>
              <option value="no">아니오</option>
            </select>

            <button type="button" class="btnPrimary" id="goResultBtn" disabled style="width:100%; margin-top:10px;">
              결과 확인하기
            </button>
          </div>
        </div>
      </section>

      <!-- STEP 2 -->
      <section id="step2" class="page">
        <div class="card">
          <h2 id="resultTitle">판정 결과</h2>
          <div id="resultBadge" class="badge bad">계산 중...</div>

          <div class="grid" style="margin-top:18px">
            <div style="background:#f9fafb; padding:15px; border-radius:12px; border:1px solid #eee;">
              <div style="font-size:12px; color:#666">계산된 eGFR</div>
              <div id="egfrView" style="font-size:24px; font-weight:900; color:var(--brand)">-</div>
            </div>
            <div style="background:#f9fafb; padding:15px; border-radius:12px; border:1px solid #eee;">
              <div style="font-size:12px; color:#666">참고 상병코드</div>
              <div id="codeView" style="font-size:24px; font-weight:900; color:#333">-</div>
            </div>
          </div>

          <div style="margin-top:18px">
            <label>심사기준 요약문</label>
            <textarea id="summaryText" readonly></textarea>
          </div>

          <div class="btnRow">
            <button type="button" class="btnLite" id="backTo1">수정하기</button>
            <button type="button" class="btnPrimary" id="restart">새로 시작</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ✅ DOM 이후에 실행되도록 맨 아래에 스크립트 -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      // 에러가 나도 “왜”인지 화면에 보여주기 (콘솔 못 봐도 확인 가능)
      function debug(msg){
        const el = $("debug");
        if(!el) return;
        el.textContent = msg;
        el.classList.add("show");
      }

      // 전역 에러 캐치 (JS 멈춤 원인 찾기)
      window.addEventListener("error", (e)=>{
        debug("스크립트 오류: " + (e.message || "unknown"));
      });

      const state = { gender: "", age: 0 };

      function setStep(idx){
        $("step0").classList.toggle("active", idx === 0);
        $("step1").classList.toggle("active", idx === 1);
        $("step2").classList.toggle("active", idx === 2);

        $("chip0").classList.toggle("active", idx === 0);
        $("chip1").classList.toggle("active", idx === 1);
        $("chip2").classList.toggle("active", idx === 2);

        window.scrollTo(0,0);
      }

      // Step0 유효성 + 버튼 활성화
      function updateStartUI(){
        const g = $("gender0").value;
        const a = $("age0").value;
        const ok = (g !== "" && a !== "" && Number(a) > 0);

        const btn = $("goExtraBtn");
        btn.disabled = !ok;
        btn.classList.toggle("active", ok);

        $("startHint").textContent = ok
          ? "준비되었습니다. 버튼을 누르면 다음 단계로 이동합니다."
          : "성별과 나이를 입력하면 다음 단계로 이동할 수 있어요.";
      }

      function goStep1(){
        const g = $("gender0").value;
        const a = parseInt($("age0").value, 10);

        if(!g || !a){
          updateStartUI();
          return;
        }

        state.gender = g;
        state.age = a;

        $("genderFixed").value = (g === "male") ? "남성" : "여성";
        $("ageFixed").value = a + "세";

        setStep(1);
        updateExtraUI();
      }

      // Step1 단백뇨 입력 전환
      function toggleProteinInput(){
        const isDip = $("proteinTest").value === "dipstick";
        $("dipstickWrap").style.display = isDip ? "block" : "none";
        $("uacrWrap").style.display = isDip ? "none" : "block";
        updateExtraUI();
      }

      // Step1 입력 체크
      function updateExtraUI(){
        const scr = $("creatinine").value;
        const k = $("potassium").value;
        const db = $("diabetes").value;
        const ace = $("aceArb").value;

        let protOk = false;
        if ($("proteinTest").value === "dipstick") {
          protOk = $("dipstick").value !== "";
        } else {
          protOk = $("uacr").value !== "";
        }

        const ok = (scr && k && db && ace && protOk);
        $("goResultBtn").disabled = !ok;
      }

      // eGFR (CKD-EPI 2021)
      function calcEGFR(gender, age, scr){
        const kappa = (gender === "female") ? 0.7 : 0.9;
        const alpha = (gender === "female") ? -0.241 : -0.302;
        const genderMod = (gender === "female") ? 1.012 : 1.0;

        const minScr = Math.min(scr / kappa, 1);
        const maxScr = Math.max(scr / kappa, 1);

        const egfr = 142
          * Math.pow(minScr, alpha)
          * Math.pow(maxScr, -1.200)
          * Math.pow(0.9938, age)
          * genderMod;

        return Math.round(egfr);
      }

      function calculateAndShow(){
        const scr = parseFloat($("creatinine").value);
        const k = parseFloat($("potassium").value);
        const db = $("diabetes").value === "yes";
        const ace = $("aceArb").value === "yes";

        const egfr = calcEGFR(state.gender, state.age, scr);

        // 예시 급여 로직
        const isEligible = (db && ace && egfr >= 25 && k <= 4.8);

        $("egfrView").textContent = egfr + " mL/min";
        $("codeView").textContent = (egfr < 60) ? "N18.3" : "N18.2";

        const badge = $("resultBadge");
        if(isEligible){
          badge.textContent = "급여 인정 기준 충족";
          badge.className = "badge good";
          $("summaryText").value =
            `[급여 적정] eGFR ${egfr}로 기준 충족. ACE/ARB 투여 및 당뇨병 확인됨. (K=${k})`;
        }else{
          badge.textContent = "급여 불충족 / 확인 필요";
          badge.className = "badge bad";
          $("summaryText").value =
            `[급여 주의] 기준 미달 항목이 있습니다. (eGFR: ${egfr}, 칼륨: ${k})`;
        }

        setStep(2);
      }

      /* ========= 이벤트 바인딩(중요) ========= */

      // 폼 submit 자체를 완전 차단 (엔터 눌러도 리로드 방지)
      $("startForm").addEventListener("submit", (e)=> e.preventDefault());

      $("gender0").addEventListener("change", updateStartUI);
      $("age0").addEventListener("input", updateStartUI);

      // 엔터키로도 Step1 이동되게
      $("age0").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          if(!$("goExtraBtn").disabled) goStep1();
        }
      });

      $("goExtraBtn").addEventListener("click", ()=>{
        if($("goExtraBtn").disabled) return;
        goStep1();
      });

      $("proteinTest").addEventListener("change", toggleProteinInput);

      ["creatinine","potassium","diabetes","aceArb","dipstick","uacr"].forEach(id=>{
        const el = $(id);
        el.addEventListener("input", updateExtraUI);
        el.addEventListener("change", updateExtraUI);
      });

      $("goResultBtn").addEventListener("click", ()=>{
        if($("goResultBtn").disabled) return;
        calculateAndShow();
      });

      $("backTo0").addEventListener("click", ()=> setStep(0));
      $("backTo1").addEventListener("click", ()=> setStep(1));
      $("restart").addEventListener("click", ()=> location.reload());

      // 초기화
      updateStartUI();
      toggleProteinInput();
    })();
  </script>
</body>
</html>
