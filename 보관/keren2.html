<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸</title>

  <style>
    :root{
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;

      --brand:#C8102E;
      --brand2:#9B0F24;

      --shadow: 0 18px 60px rgba(17,24,39,.12);
      --radius: 22px;
      --radius2: 16px;
      --focus: 0 0 0 4px rgba(200,16,46,.14);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial, sans-serif;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      padding: 12px 16px 40px;
      background:
        radial-gradient(circle at 18% 10%, rgba(200,16,46,0.10), transparent 48%),
        radial-gradient(circle at 88% 20%, rgba(155,15,36,0.08), transparent 55%),
        linear-gradient(180deg,#ffffff 0%,#fff5f6 35%,#fde5e8 65%,#f6b9c2 100%);
    }

    /* Layout */
    .wrap{max-width:1120px;margin:0 auto;}
    .shell{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.55);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .content{padding:22px;}

    /* Topbar */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      margin: 10px 0 10px;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:14px;}
    .logo-img{height:76px;width:auto;display:block;}
    .title h1{margin:0;font-size:24px;letter-spacing:-.02em}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pill{
      font-size:12px;color:#7f1d1d;background:rgba(200,16,46,.10);
      padding:8px 10px;border-radius:999px;border:1px solid rgba(200,16,46,.18);
      white-space:nowrap;
    }

    /* Sticky stepper */
    .sticky-stepper{
      position: sticky; top: 0; z-index: 50;
      margin: 6px 0 14px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(17,24,39,.08);
    }
    .steps{display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:center}
    .step{
      display:flex;align-items:center;gap:10px;
      color:var(--muted);font-size:13px;
      cursor:pointer; user-select:none;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .step:hover{background: rgba(17,24,39,.03);}
    .dot{
      width:26px;height:26px;border-radius:999px;
      display:grid;place-items:center;border:1px solid var(--line);
      background:#fff;font-weight:800;color:var(--muted);
    }
    .step.active{color:#111827}
    .step.active .dot{
      border-color:rgba(200,16,46,.55);
      background:rgba(200,16,46,.10);
      color:#7f1d1d;
    }
    .connector{width:56px;height:2px;background:rgba(229,231,235,.9);border-radius:999px;}
    @media (max-width: 860px){ .connector{display:none} }

    /* Common grid/cards */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius:var(--radius2);
      padding:18px;
      box-shadow: 0 10px 28px rgba(17,24,39,.06);
    }

    /* Step 0 Hero (balanced) */
    .hero-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;               /* âœ… ì¤‘ì•™ ê°„ê²© í†µì œ */
      padding: 14px;           /* âœ… ê³¼í•œ ê³µë°± ì¤„ì´ê¸° */
      min-height: 440px;       /* âœ… ê³¼ë„í•œ ë¹ˆ ê³µê°„ ê°ì†Œ */
    }
    @media (max-width: 920px){
      .hero-grid{grid-template-columns:1fr; padding: 12px; min-height:auto;}
    }

    .hero-left{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
      border-radius: 18px;
    }
    .hero-left img{
      width:100%;
      max-width: 380px;        /* âœ… (420â†’380) ì„¸ë¡œí˜• ì´ë¯¸ì§€ ì°©ì‹œ ì™„í™” */
      height:auto;
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.85);
      box-shadow: 0 18px 48px rgba(17,24,39,.10);
      background:#fff;
      display:block;
    }

    .hero-right{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;      /* âœ… íŒ¨ë„ ì¤‘ì•™ ì •ë ¬ */
      padding: 24px;
      background: linear-gradient(
        180deg,
        rgba(255,245,246,.75) 0%,
        rgba(253,229,232,.55) 55%,
        rgba(246,185,194,.45) 100%
      );
      border-radius: 18px;
      border: 1px solid rgba(200,16,46,.10);
    }
    .hero-panel{
      max-width: 420px;
      width: 100%;
      padding: 22px;
      border-radius: 18px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(229,231,235,.92);
      box-shadow: 0 10px 26px rgba(17,24,39,.08);
    }
    .hero-panel h2{margin:0 0 8px;font-size:20px;letter-spacing:-.01em}
    .hero-panel p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.5}

    /* Forms */
    label{display:block;font-size:12px;color:#374151;margin:10px 0 6px;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    textarea{min-height:160px;resize:vertical}
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus);border-color:rgba(200,16,46,.45)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 420px){ .row2{grid-template-columns:1fr} }
    .hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(229,231,235,.9);margin:12px 0}

    /* Buttons */
    .btn{
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      color:#111827;
      border-radius:14px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform, .15s background;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{
      border-color:rgba(200,16,46,.35);
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;
    }
    .btn.primary:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .btn.danger{
      background:rgba(220,38,38,.08);
      border-color:rgba(220,38,38,.18);
      color:#991b1b;
    }

    /* Badges / KPI */
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(229,231,235,.9);
      background:#fff;white-space:nowrap;
    }
    .badge.good{color:#065f46;border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.12)}
    .badge.bad{color:#7f1d1d;border-color:rgba(200,16,46,.25);background:rgba(200,16,46,.10)}

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width: 860px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      padding:14px;border-radius:16px;border:1px solid rgba(229,231,235,.92);
      background:rgba(249,250,251,.75);
    }
    .kpi .box .k{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:22px;font-weight:950;margin-top:6px;line-height:1.15}
    .kpi .box .v .sub{display:block;font-size:13px;font-weight:600;color:var(--muted);margin-top:2px}

    /* Tabs */
    .tabs{
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(249,250,251,.6);
      padding:6px;
      border-radius:999px;
      width:fit-content;
    }
    .tab{
      border:1px solid transparent;
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:#374151;
      cursor:pointer;
    }
    .tab.active{
      background:#fff;
      border-color:rgba(200,16,46,.18);
      color:#7f1d1d;
      box-shadow: 0 10px 24px rgba(17,24,39,.06);
    }
    .tabpanel{display:none}
    .tabpanel.active{display:block}

    /* Modal & Toast */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(17,24,39,.55);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:9998;
    }
    .modal-backdrop.open{display:flex}
    .modal{
      width:min(520px, 100%);
      background:#fff;border-radius:22px;overflow:hidden;
      box-shadow:0 20px 70px rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.4);
      padding:20px;
      text-align:center;
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#fff;
      padding:10px 12px;border-radius:12px;
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      font-size:13px;
      opacity:0;pointer-events:none;
      transition:.18s opacity;
      z-index:9999;
    }
    .toast.show{opacity:1}

    /* Print (keep minimal like your version) */
    .print-header{display:none}
    @media print{
      body{background:#fff;padding:0}
      .no-print{display:none !important}
      .print-header{display:flex !important;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:20px}
      .shell{box-shadow:none;border:none;background:#fff}
      .content{padding:0}
      .card{box-shadow:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar no-print">
      <div class="brand">
        <img src="kerendia-logo-transparent.png" alt="Kerendia" class="logo-img">
        <div class="title">
          <h1>ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸</h1>
          <p>CKD-EPI (2021) eGFR ê³„ì‚° ë° ê¸‰ì—¬ ê¸°ì¤€ ìš”ì•½</p>
        </div>
      </div>
      <div class="pill">ì˜ë£Œì§„ ì°¸ê³ ìš©</div>
    </div>

    <div class="sticky-stepper no-print">
      <div class="steps">
        <div class="step active" id="step0Chip"><span class="dot">0</span> ì‹œì‘</div>
        <div class="connector"></div>
        <div class="step" id="step1Chip"><span class="dot">1</span> ì¶”ê°€ ì…ë ¥</div>
        <div class="connector"></div>
        <div class="step" id="step2Chip"><span class="dot">2</span> ê²°ê³¼</div>
      </div>
    </div>

    <div class="shell">
      <div class="content">

        <div class="print-header">
          <div style="display:flex; align-items:center; gap:10px;">
            <img src="kerendia-logo-transparent.png" height="30" alt="Logo">
            <strong>ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼</strong>
          </div>
          <div id="printTime" style="font-size:12px;"></div>
        </div>

        <!-- STEP 0 -->
        <div id="step0">
          <div class="hero-grid">
            <div class="hero-left">
              <img src="with-kerendia-hero-pink.png" alt="Hero">
            </div>
            <div class="hero-right">
              <div class="hero-panel">
                <h2>ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
                <p>ì„±ë³„ê³¼ ë‚˜ì´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ê²€ì‚¬ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>

                <label for="gender0">ì„±ë³„</label>
                <select id="gender0" onchange="updateStartUI()">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="male">ë‚¨ì„±</option>
                  <option value="female">ì—¬ì„±</option>
                </select>

                <label for="age0">ë‚˜ì´</label>
                <input type="number" id="age0" placeholder="ì˜ˆ: 62" oninput="updateStartUI()">

                <button class="btn primary" id="goExtraBtn"
                        style="width:100%; margin-top:18px;"
                        disabled
                        onclick="goStep1()">
                  ê¸‰ì—¬ëŒ€ìƒ í™•ì¸ ì‹œì‘
                </button>

                <div class="hint" id="startHint" style="text-align:center; margin-top:10px;">
                  ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 1 -->
        <div id="step1" style="display:none;">
          <div class="grid">
            <div class="card">
              <div class="row2">
                <div>
                  <label>ì„±ë³„</label>
                  <input id="genderFixed" readonly style="background:#f9fafb;">
                </div>
                <div>
                  <label>ë‚˜ì´</label>
                  <input id="ageFixed" readonly style="background:#f9fafb;">
                </div>
              </div>

              <div class="divider"></div>

              <div class="row2">
                <div>
                  <label>í˜ˆì²­ í¬ë ˆì•„í‹°ë‹Œ (mg/dL)</label>
                  <input id="creatinine" type="number" step="0.1" placeholder="ì˜ˆ: 1.2" oninput="updateExtraUI()">
                </div>
                <div>
                  <label>ì¹¼ë¥¨ (mmol/L)</label>
                  <input id="potassium" type="number" step="0.1" placeholder="ì˜ˆ: 4.5" oninput="updateExtraUI()">
                </div>
              </div>

              <div class="hint">ì¹¼ë¥¨ ì‹œì‘ ê¶Œì¥ ê¸°ì¤€: â‰¤ 4.8</div>

              <button class="btn no-print" style="margin-top:18px;" onclick="goStep(0)">
                ì‹œì‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>

            <div class="card">
              <label>ë‹¨ë°±ë‡¨ ê²€ì‚¬ ë°©ë²•</label>
              <select id="proteinTest" onchange="toggleProteinView(); updateExtraUI();">
                <option value="dipstick">ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ (Dipstick)</option>
                <option value="uacr">uACR (ìš”ì•Œë¶€ë¯¼/í¬ë ˆì•„í‹°ë‹Œë¹„)</option>
              </select>

              <div id="dipstickWrap">
                <label>Dipstick ê²°ê³¼</label>
                <select id="dipstick" onchange="updateExtraUI()">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="negative">ìŒì„± (-)</option>
                  <option value="trace">ì•½ì–‘ì„± (Â±)</option>
                  <option value="1plus">1+</option>
                  <option value="2plus">2+</option>
                  <option value="3plus">3+</option>
                </select>
              </div>

              <div id="uacrWrap" style="display:none;">
                <label>uACR (mg/g)</label>
                <input id="uacr" type="number" placeholder="ì˜ˆ: 350" oninput="updateExtraUI()">
              </div>

              <div class="divider"></div>

              <label>ì¶”ê°€ ê¸‰ì—¬ ì¡°ê±´</label>
              <div style="display:grid; gap:8px;">
                <select id="diabetes" onchange="updateExtraUI()">
                  <option value="">ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ìì…ë‹ˆê¹Œ?</option>
                  <option value="yes">ì˜ˆ</option>
                  <option value="no">ì•„ë‹ˆì˜¤</option>
                </select>
                <select id="aceArb" onchange="updateExtraUI()">
                  <option value="">ACEi/ARB ìµœëŒ€í—ˆìš©ëŸ‰ 4ì£¼ ì´ìƒ íˆ¬ì—¬ì¤‘?</option>
                  <option value="yes">ì˜ˆ</option>
                  <option value="no">ì•„ë‹ˆì˜¤</option>
                </select>
                <select id="heartFailure" onchange="updateExtraUI()">
                  <option value="">ë§Œì„± ì‹¬ë¶€ì „(NYHA II~IV) ë™ë°˜?</option>
                  <option value="no">ì•„ë‹ˆì˜¤ (ê¸‰ì—¬ ì¸ì •)</option>
                  <option value="yes">ì˜ˆ (ê¸‰ì—¬ ì œì™¸)</option>
                </select>
              </div>

              <button class="btn primary" id="goResultBtn"
                      style="width:100%; margin-top:18px;"
                      disabled
                      onclick="calculateResult()">
                ê²°ê³¼ í™•ì¸í•˜ê¸°
              </button>
            </div>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" style="display:none;">
          <div class="grid">
            <div class="card">
              <div id="resultBadge" class="badge">ê³„ì‚° ì¤‘...</div>

              <div class="kpi">
                <div class="box">
                  <div class="k">eGFR (CKD-EPI)</div>
                  <div class="v" id="egfrView">-</div>
                </div>
                <div class="box">
                  <div class="k">ìƒë³‘ì½”ë“œ(ì°¸ê³ )</div>
                  <div class="v" id="codeView">-</div>
                </div>
              </div>

              <div id="reasonSection" style="margin-top:14px; display:none;">
                <div class="badge bad">ê¸‰ì—¬ ì œì™¸ ì‚¬ìœ </div>
                <ul id="reasons" style="font-size:13px; color:#c8102e; padding-left:20px; margin:6px 0 0;"></ul>
              </div>

              <div id="okSection" style="margin-top:14px; display:none;">
                <div class="badge good">ê¸‰ì—¬ ê¸°ì¤€ ì¶©ì¡±</div>
                <ul id="oks" style="font-size:13px; color:#065f46; padding-left:20px; margin:6px 0 0;"></ul>
              </div>

              <button class="btn no-print" style="width:100%; margin-top:14px;" onclick="goStep(1)">
                ì¶”ê°€ ì…ë ¥ìœ¼ë¡œ
              </button>
            </div>

            <div class="card">
              <div class="tabs no-print">
                <button class="tab active" id="tabBtnSummary" onclick="showTab('summary')">ìš”ì•½ë¬¸</button>
                <button class="tab" id="tabBtnCaution" onclick="showTab('caution')">ë³µìš© ì£¼ì˜ì‚¬í•­</button>
              </div>

              <div id="tabSummary" class="tabpanel active" style="margin-top:14px;">
                <label>ìš”ì•½ë¬¸</label>
                <textarea id="summaryText" readonly></textarea>
                <div class="row2 no-print" style="margin-top:10px;">
                  <button class="btn primary" onclick="copySummary()">í…ìŠ¤íŠ¸ ë³µì‚¬</button>
                  <button class="btn" onclick="window.print()">PDF í”„ë¦°íŠ¸</button>
                </div>
              </div>

              <div id="tabCaution" class="tabpanel" style="margin-top:14px;">
                <div id="cautionText" style="font-size:13px; line-height:1.6; white-space:pre-wrap;">
                  (ì£¼ì˜ì‚¬í•­ ë°ì´í„° ë¡œë”© ì¤‘...)
                </div>
                <button class="btn no-print" style="width:100%; margin-top:10px;" onclick="window.print()">
                  ì£¼ì˜ì‚¬í•­ í”„ë¦°íŠ¸
                </button>
              </div>

              <button class="btn danger no-print" style="width:100%; margin-top:12px;" onclick="confirmReset()">
                ìƒˆë¡œ ê²€ì‚¬í•˜ê¸°
              </button>
            </div>
          </div>
        </div>

      </div><!-- content -->
    </div><!-- shell -->
  </div><!-- wrap -->

  <!-- Reset Modal -->
  <div class="modal-backdrop" id="resetModal" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 style="margin:0 0 8px;">ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
      <p style="color:var(--muted); font-size:14px; margin:0 0 14px;">
        ëª¨ë“  ì…ë ¥ê°’ì´ ì‚¬ë¼ì§€ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
      </p>
      <div class="row2">
        <button class="btn" onclick="closeModal('resetModal')">ì·¨ì†Œ</button>
        <button class="btn primary" onclick="resetAll()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

  <script>
    const $ = id => document.getElementById(id);
    const state = { gender: "", age: "" };

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1500);
    }

    function goStep(idx){
      ["step0","step1","step2"].forEach((id,i)=>$(id).style.display = (i===idx) ? "block" : "none");
      ["step0Chip","step1Chip","step2Chip"].forEach((id,i)=>$(id).classList.toggle("active", i===idx));
      window.scrollTo(0,0);
    }

    function updateStartUI(){
      const ok = $("gender0").value && $("age0").value;
      $("goExtraBtn").disabled = !ok;
      $("startHint").textContent = ok ? "ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    }

    function goStep1(){
      state.gender = $("gender0").value;
      state.age = $("age0").value;
      $("genderFixed").value = (state.gender === "male") ? "ë‚¨ì„±" : "ì—¬ì„±";
      $("ageFixed").value = state.age + "ì„¸";
      goStep(1);
    }

    function toggleProteinView(){
      const isUacr = $("proteinTest").value === "uacr";
      $("uacrWrap").style.display = isUacr ? "block" : "none";
      $("dipstickWrap").style.display = isUacr ? "none" : "block";
    }

    function updateExtraUI(){
      const proteinOk = ($("proteinTest").value === "dipstick") ? $("dipstick").value : $("uacr").value;
      const extraOk = $("creatinine").value && $("potassium").value && $("diabetes").value && $("aceArb").value && $("heartFailure").value;
      $("goResultBtn").disabled = !(proteinOk && extraOk);
    }

    function calculateResult(){
      const scr = parseFloat($("creatinine").value);
      const k = parseFloat($("potassium").value);
      const age = parseInt(state.age, 10);
      const gender = state.gender;

      // CKD-EPI 2021 Formula
      const K = (gender === "male" ? 0.9 : 0.7);
      const alpha = (gender === "male" ? -0.302 : -0.241);
      let egfr = 142 * Math.pow(Math.min(scr / K, 1), alpha) * Math.pow(Math.max(scr / K, 1), -1.200) * Math.pow(0.9938, age);
      if(gender === "female") egfr *= 1.012;
      const roundedEgfr = Math.round(egfr);

      $("egfrView").textContent = roundedEgfr;

      // Eligibility logic (same as your last version)
      const reasons = [];
      const oks = [];

      if(roundedEgfr < 25) reasons.push("eGFR 25 ë¯¸ë§Œ");
      else if(roundedEgfr >= 75) reasons.push("eGFR 75 ì´ìƒ");
      else oks.push(`eGFR ${roundedEgfr} (ì¸ì • ë²”ìœ„ 25~75)`);

      if(k > 4.8) reasons.push("í˜ˆì¤‘ ì¹¼ë¥¨ 4.8 mmol/L ì´ˆê³¼");
      else oks.push(`ì¹¼ë¥¨ ${k} mmol/L (ì¸ì • ë²”ìœ„ â‰¤ 4.8)`);

      if($("proteinTest").value === "uacr"){
        const u = parseFloat($("uacr").value);
        if(u <= 300) reasons.push("uACR 300 mg/g ì´í•˜");
        else oks.push(`uACR ${u} mg/g (ì¸ì • ë²”ìœ„ > 300)`);
      }else{
        const d = $("dipstick").value;
        if(d === "negative" || d === "trace") reasons.push("Dipstick 1+ ë¯¸ë§Œ");
        else oks.push(`Dipstick ${d} (ì¸ì • ë²”ìœ„ 1+ ì´ìƒ)`);
      }

      if($("diabetes").value === "no") reasons.push("ì œ2í˜• ë‹¹ë‡¨ë³‘ ë¯¸ë™ë°˜");
      if($("aceArb").value === "no") reasons.push("ACEi/ARB ìµœëŒ€ ìš©ëŸ‰ 4ì£¼ íˆ¬ì—¬ ë¯¸ì¶©ì¡±");
      if($("heartFailure").value === "yes") reasons.push("ë§Œì„± ì‹¬ë¶€ì „(NYHA II~IV) ë™ë°˜ (ê¸‰ì—¬ ì œì™¸)");

      const isOk = reasons.length === 0;

      $("resultBadge").textContent = isOk ? "ê¸‰ì—¬ ê¸°ì¤€ ì¶©ì¡±" : "ê¸‰ì—¬ ë¶€ì í•©";
      $("resultBadge").className = "badge " + (isOk ? "good" : "bad");

      $("reasonSection").style.display = isOk ? "none" : "block";
      $("okSection").style.display = isOk ? "block" : "none";
      $("reasons").innerHTML = reasons.map(r => `<li>${r}</li>`).join("");
      $("oks").innerHTML = oks.map(o => `<li>${o}</li>`).join("");

      // Disease code display (with line breaks)
      let code = "-";
      if(roundedEgfr >= 60 && roundedEgfr < 75) code = "N18.2<br><span class='sub'>(ë§Œì„±ì‹ ì¥ë³‘ 2ê¸°)</span>";
      else if(roundedEgfr >= 30 && roundedEgfr < 60) code = "N18.3<br><span class='sub'>(ë§Œì„±ì‹ ì¥ë³‘ 3ê¸°)</span>";
      else if(roundedEgfr >= 25 && roundedEgfr < 30) code = "N18.4<br><span class='sub'>(ë§Œì„±ì‹ ì¥ë³‘ 4ê¸°)</span>";
      $("codeView").innerHTML = code;

      $("summaryText").value =
`[ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼]
- í™˜ì ì •ë³´: ${$("genderFixed").value}, ${state.age}ì„¸
- eGFR: ${roundedEgfr} mL/min/1.73ã¡
- ì¹¼ë¥¨: ${k} mmol/L
- íŒì •: ${isOk ? "ê¸‰ì—¬ ê°€ëŠ¥" : "ê¸‰ì—¬ ë¶ˆê°€"}
${!isOk ? "- ì‚¬ìœ : " + reasons.join(", ") : "- ëª¨ë“  ê¸°ì¤€ ì¶©ì¡±"}`;

      $("printTime").textContent = "ì¶œë ¥ ì¼ì‹œ: " + new Date().toLocaleString();

      initCaution();
      showTab("summary");
      goStep(2);
    }

    function showTab(name){
      const isSummary = (name === "summary");
      $("tabSummary").classList.toggle("active", isSummary);
      $("tabCaution").classList.toggle("active", !isSummary);
      $("tabBtnSummary").classList.toggle("active", isSummary);
      $("tabBtnCaution").classList.toggle("active", !isSummary);
    }

    function copySummary(){
      $("summaryText").select();
      document.execCommand("copy");
      toast("ìš”ì•½ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function confirmReset(){ $("resetModal").classList.add("open"); }
    function closeModal(id){ $(id).classList.remove("open"); }
    function resetAll(){ location.reload(); }

    function initCaution(){
      $("cautionText").textContent =
`í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­
PDF ì¶œë ¥ ê°€ëŠ¥

í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­:
- ì¼€ë Œë””ì•„(Finerenone)ëŠ” ì‹ ì¥ ë³´í˜¸ ë° ì‹¬í˜ˆê´€ ì§ˆí™˜ ì˜ˆë°©ì„ ìœ„í•œ ì•½ì œë¡œ, 2í˜• ë‹¹ë‡¨ë³‘ê³¼ ë§Œì„±ì‹ ì¥ë³‘(CKD) í™˜ìì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

- ë³µìš© ì¤‘ ê³ ì¹¼ë¥¨í˜ˆì¦ì˜ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
- ê³ ì¹¼ë¥¨í˜ˆì¦ ì¦ìƒ: ê·¼ìœ¡ ì•½í™”, í”¼ë¡œê°, ë¬´ê¸°ë ¥, ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê±°ë‚˜ ëŠë ¤ì§€ëŠ” ëŠë‚Œ(ë¶€ì •ë§¥)
  ì´ëŸ¬í•œ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ë©´ ì¦‰ì‹œ ì˜ë£Œì§„ì—ê²Œ ì•Œë¦¬ì‹­ì‹œì˜¤.
- ê³ í˜ˆì••ì•½(RAASì–µì œì œ)ê³¼ ë³‘ìš© ì‹œ ì „í•´ì§ˆ ì´ìƒì„ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•©ë‹ˆë‹¤.
- ì´ìƒ ì¦ìƒ ì‹œ ì¦‰ì‹œ ì˜ë£Œì§„ì— ìƒë‹´í•˜ì„¸ìš”.
- ì˜ì‚¬ ì§€ì‹œ ì—†ì´ ë³µìš©ì„ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì¦ëŸ‰í•˜ì§€ ë§ˆì„¸ìš”.

âœ” CKD í™˜ìëŠ” ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ë¡œ í˜ˆì¤‘ ì¹¼ë¥¨ ë†ë„ë¥¼ í™•ì¸í•˜ê³ , ì¹¼ë¥¨ ì„­ì·¨ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.

ğŸ½ ì¹¼ë¥¨ ì„­ì·¨ë¥¼ ì¤„ì´ëŠ” ë°©ë²•:
 1. ì•¼ì±„ëŠ” ë“ëŠ” ë¬¼ì— ë°ì¹˜ê¸° (ì±„ì†Œ ë¬´ê²Œì˜ 4~5ë°° ì´ìƒ ë¬¼ ì‚¬ìš©)
 2. ì–‡ê²Œ ì¬ í›„ ì°¬ë¬¼ì— 2ì‹œê°„ ë‹´ê°”ë‹¤ê°€ ë¬¼ì„ ë²„ë¦¬ê³  ì¡°ë¦¬
 3. ì±„ì†Œ ê»ì§ˆê³¼ ì¤„ê¸° ì œê±° í›„ ì„­ì·¨

âš ï¸ ì¹¼ë¥¨ì´ ë§ì€ ì‹í’ˆ ì£¼ì˜:
- ê°ì, ê³ êµ¬ë§ˆ, í† ë§ˆí† , ë°”ë‚˜ë‚˜, í‚¤ìœ„, ë©œë¡ 
- ì‹œê¸ˆì¹˜, ë¯¸ì—­, ë‹¤ì‹œë§ˆ, ì½©, ê²¬ê³¼ë¥˜
- ì´ˆì½œë¦¿, ì»¤í”¼, ë‘ìœ , ì£¼ìŠ¤, ì¸ìŠ¤í„´íŠ¸êµ­, í™ì‚¼ì ¤ë¦¬ ë“±

ğŸ’§ ìˆ˜ë¶„ ì„­ì·¨ëŠ” ì‹ ì¥ ìƒíƒœì— ë”°ë¼ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì—¬ ê²°ì •í•˜ì„¸ìš”.
(ì¶œì²˜: CKD in T2D Awareness Symposium, Kerendia & ì¢…ê·¼ë‹¹)`;
}
    });
    $("step2Chip").addEventListener("click", ()=>{
      if($("step2").style.display !== "none") goStep(2);
      else toast("ë¨¼ì € ì…ë ¥ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    });

    // Init
    updateStartUI();
    toggleProteinView();
    updateExtraUI();
    goStep(0);
  </script>
</body>
</html>
