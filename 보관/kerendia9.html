<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸</title>

  <style>
    :root{
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;

      --brand:#C8102E;
      --brand2:#9B0F24;

      --shadow: 0 18px 60px rgba(17,24,39,.12);
      --radius: 22px;
      --radius2: 16px;
      --focus: 0 0 0 4px rgba(200,16,46,.14);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial, sans-serif;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      padding: 12px 16px 40px;

      /* ìœ„ëŠ” ë°ê²Œ, ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ì§„í•˜ê²Œ */
      background:
        radial-gradient(circle at 18% 10%, rgba(200,16,46,0.10), transparent 48%),
        radial-gradient(circle at 88% 20%, rgba(155,15,36,0.08), transparent 55%),
        linear-gradient(
          180deg,
          #ffffff 0%,
          #fff5f6 35%,
          #fde5e8 65%,
          #f6b9c2 100%
        );
    }

    .wrap{max-width:1100px;margin:0 auto;}

    /* Top */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      margin: 10px 0 10px;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:0;}
    .logo-img{height:72px;width:auto;display:block;}
    .title{min-width:0;}
    .title h1{margin:0;font-size:24px;letter-spacing:-.02em}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pill{
      font-size:12px;color:#7f1d1d;background:rgba(200,16,46,.10);
      padding:8px 10px;border-radius:999px;border:1px solid rgba(200,16,46,.18);
      white-space:nowrap;
    }

    /* Sticky Stepper */
    .sticky-stepper{
      position: sticky;
      top: 0;
      z-index: 50;
      margin: 6px 0 14px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(17,24,39,.08);
    }
    .steps{display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:center}
    .step{
      display:flex;align-items:center;gap:10px;
      color:var(--muted);font-size:13px;
      cursor:pointer; user-select:none;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .step:hover{background: rgba(17,24,39,.03);}
    .dot{
      width:26px;height:26px;border-radius:999px;
      display:grid;place-items:center;border:1px solid var(--line);
      background:#fff;font-weight:800;color:var(--muted);
    }
    .step.active{color:#111827}
    .step.active .dot{
      border-color:rgba(200,16,46,.55);
      background:rgba(200,16,46,.10);
      color:#7f1d1d;
    }
    .connector{width:56px;height:2px;background:rgba(229,231,235,.9);border-radius:999px;}
    @media (max-width: 860px){ .connector{display:none} }

    /* Shell */
    .shell{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.55);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .content{padding:22px;}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius:var(--radius2);
      padding:18px;
      box-shadow: 0 10px 28px rgba(17,24,39,.06);
    }

    .section-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:0 0 12px;
    }
    .section-title h2{margin:0;font-size:16px;letter-spacing:-.01em}
    .section-title small{color:var(--muted)}
    .muted{color:var(--muted)}

    label{display:block;font-size:12px;color:#374151;margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    textarea{min-height:150px;resize:vertical}
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus);border-color:rgba(200,16,46,.45)}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 520px){ .row2{grid-template-columns:1fr} }

    .hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(229,231,235,.9);margin:12px 0}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
    .btn{
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      color:#111827;
      border-radius:14px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform, .15s background;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{
      border-color:rgba(200,16,46,.35);
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;
    }
    .btn.primary[disabled]{opacity:.55;cursor:not-allowed;transform:none}
    .btn.soft{background:rgba(200,16,46,.10);border-color:rgba(200,16,46,.20);color:#7f1d1d;}
    .btn.danger{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.18);color:#991b1b;}
    .btn.ghost{background:transparent;}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(229,231,235,.9);
      background:#fff;white-space:nowrap;
    }
    .badge.good{color:#065f46;border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.12)}
    .badge.bad{color:#7f1d1d;border-color:rgba(200,16,46,.25);background:rgba(200,16,46,.10)}

    /* Step 0 hero layout */
    .hero{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
    }
    .hero-left{
      border-radius:var(--radius2);
      border:1px solid rgba(229,231,235,.95);
      background: linear-gradient(180deg, rgba(219,238,255,.85), rgba(191,228,255,.75));
      padding:20px;
      overflow:hidden;
      position:relative;
      min-height:360px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hero-left .caption{
      position:absolute;
      left:20px; top:18px;
      right:20px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:2;
    }
    .hero-left .caption .big{
      font-weight:950;
      letter-spacing:-.02em;
      font-size:34px;
      line-height:1.05;
      color:#1f4b7a;
      text-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    .hero-left .caption .sub{
      color:rgba(31,75,122,.88);
      font-size:14px;
      letter-spacing:-.01em;
    }
    .hero-art{
      width:min(340px, 100%);
      height:auto;
      z-index:1;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.16));
    }
    .sparkle{
      position:absolute;
      right:18px; bottom:18px;
      opacity:.5;
      transform: rotate(10deg);
    }

    /* Step 1 fixed summary bar */
    .fixed-summary{
      border:1px solid rgba(229,231,235,.95);
      background:rgba(249,250,251,.8);
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .fixed-summary .left{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      color:#111827;
      font-weight:900;
    }
    .fixed-summary .pill2{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:#fff;border:1px solid rgba(229,231,235,.95);
      font-size:12px;font-weight:900;
      color:#111827;
    }
    .fixed-summary .edit{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
    }
    .fixed-summary .edit label{margin:0 0 6px}
    .fixed-summary .edit .field{min-width:180px}
    @media (max-width: 520px){
      .fixed-summary .edit .field{min-width: 100%}
    }

    /* Result */
    .result-head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:12px;}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width: 860px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      padding:14px;border-radius:16px;border:1px solid rgba(229,231,235,.92);
      background:rgba(249,250,251,.75);
    }
    .kpi .box .k{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:22px;font-weight:950;margin-top:6px}

    /* ìƒë³‘ì½”ë“œ ì¤„ë°”ê¿ˆ */
    #codeView{
      line-height: 1.15;
      word-break: keep-all;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    /* Tabs */
    .tabs{
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(249,250,251,.6);
      padding:6px;
      border-radius:999px;
      width:fit-content;
    }
    .tab{
      border:1px solid transparent;
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:#374151;
      cursor:pointer;
    }
    .tab.active{
      background:#fff;
      border-color:rgba(200,16,46,.18);
      color:#7f1d1d;
      box-shadow: 0 10px 24px rgba(17,24,39,.06);
    }
    .tabpanels{margin-top:12px}
    .tabpanel{display:none}
    .tabpanel.active{display:block}

    /* Header action (new exam button area) */
    .header-with-action{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:0 0 12px;
    }
    .header-with-action .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .btn-reset{
      white-space:nowrap;
      padding:10px 14px;
      font-weight:900;
    }
    @media (max-width: 860px){
      .header-with-action{flex-direction:column;align-items:flex-start}
      .btn-reset{align-self:flex-end}
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#fff;
      padding:10px 12px;border-radius:12px;
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      font-size:13px;
      opacity:0;pointer-events:none;
      transition:.18s opacity;
      z-index:9999;
    }
    .toast.show{opacity:1}

    /* Modal base */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(17,24,39,.55);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:9998;
    }
    .modal-backdrop.open{display:flex}
    .modal{
      width:min(920px, 100%);
      background:#fff;border-radius:22px;overflow:hidden;
      box-shadow:0 20px 70px rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.4);
    }
    .modal header{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(249,250,251,.95));
      border-bottom:1px solid rgba(229,231,235,.9);
    }
    .modal header strong{font-size:14px}
    .modal .body{padding:14px}
    .modal img{
      width:100%;height:auto;border-radius:14px;
      border:1px solid rgba(229,231,235,.95);
      background:#f9fafb;
    }

    /* Confirm modal */
    .confirm{ width:min(520px, 100%); }
    .confirm .body{ padding:16px; }
    .confirm .msg-title{ font-weight:950; margin:0 0 6px; letter-spacing:-.01em; }
    .confirm .msg-desc{ margin:0; color:var(--muted); font-size:13px; line-height:1.5; }
    .confirm .footer{
      display:flex; gap:10px; padding:14px 16px;
      border-top:1px solid rgba(229,231,235,.9);
      justify-content:flex-end;
      background:rgba(249,250,251,.8);
    }
    .confirm .footer .btn{ padding:10px 12px; border-radius:12px; }

    /* Print header */
    .print-header{
      display:none;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:12px 0 10px;
      margin:0 0 12px;
      border-bottom:1px solid #e5e7eb;
    }
    .print-header .ph-left{display:flex;align-items:center;gap:12px;min-width:0;}
    .print-header .ph-logo{height:26px;width:auto;display:block;}
    .print-header .ph-title{line-height:1.25;min-width:0;}
    .print-header .ph-title .doc{
      font-weight:950;font-size:14px;letter-spacing:-.01em;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;
    }
    .print-header .ph-title .sub{
      font-size:11px;color:#6b7280;margin-top:3px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;
    }
    .print-header .ph-right{text-align:right;font-size:11px;color:#374151;white-space:nowrap;}

    body.print-summary-only #cautionBlock { display:none !important; }
    body.print-caution-only .print-area { display:none !important; }
    body.print-caution-only #cautionBlock { display:block !important; }

    body.print-caution-only #cautionBlock .caution-text{
      font-size: 11px !important;
      line-height: 1.45 !important;
      letter-spacing: -0.01em;
      word-break: keep-all;
    }
    body.print-caution-only #cautionBlock ul{margin: 6px 0 0 16px !important;}
    body.print-caution-only #cautionBlock li{margin: 2px 0 !important;}

    @page { margin: 14mm; }

    @media print{
      body{background:#fff;padding:0}
      .topbar,.sticky-stepper,.no-print,.modal-backdrop,.toast{display:none !important}
      .shell{box-shadow:none;border:none;background:#fff}
      .content{padding:0}
      .card{box-shadow:none}
      .print-header{display:flex !important;}
      textarea{border:1px solid #e5e7eb !important;white-space:pre-wrap !important;}
      .print-area{break-inside:avoid;page-break-inside:avoid;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img src="with-kerendia-hero-pink.png" alt="with ì¼€ë Œë””ì•„" class="hero-img" />
        <div class="title">
          <h1>ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸</h1>
          <p>CKD-EPI Creatinine Equation (2021) ê¸°ë°˜ eGFR ê³„ì‚° Â· ê¸‰ì—¬ ê¸°ì¤€ ìš”ì•½</p>
        </div>
      </div>
      <div class="pill">Kerendia í†¤ Â· 1íŒŒì¼ HTML</div>
    </div>

    <!-- Sticky Stepper: 0(ì‹œì‘) / 1(ì¶”ê°€ì…ë ¥) / 2(ê²°ê³¼) -->
    <div class="sticky-stepper no-print">
      <div class="steps">
        <div class="step active" id="step0Chip"><span class="dot">0</span> ì‹œì‘</div>
        <div class="connector"></div>
        <div class="step" id="step1Chip"><span class="dot">1</span> ì¶”ê°€ ì…ë ¥</div>
        <div class="connector"></div>
        <div class="step" id="step2Chip"><span class="dot">2</span> ê²°ê³¼</div>
      </div>
    </div>

    <div class="shell">
      <div class="content">

        <!-- PRINT HEADER -->
        <div class="print-header" id="printHeader">
          <div class="ph-left">
            <img class="ph-logo" src="kerendia-logo-transparent.png" alt="Kerendia">
            <div class="ph-title">
              <div class="doc" id="printDocTitle">ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼</div>
              <div class="sub" id="printDocSub">ìš”ì•½ë¬¸ ë° í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­</div>
            </div>
          </div>
          <div class="ph-right">
            <div><strong>ì¶œë ¥ì¼ì‹œ</strong></div>
            <div id="printTime">â€”</div>
          </div>
        </div>

        <!-- STEP 0 : ì²« í™”ë©´ (ì¢Œ ì´ë¯¸ì§€ + ìš° ì„±ë³„/ë‚˜ì´) -->
        <div id="step0">
          <div class="hero">
            <div class="hero-left">
              <div class="caption">
                <div class="big">with ì¼€ë Œë””ì•„</div>
                <div class="sub">ë‹¹ë‡¨ë³‘ì„ ë™ë°˜í•œ ë§Œì„± ì½©íŒ¥ë³‘ ì¹˜ë£Œ Â· ê¸‰ì—¬ ì ìš© ì—¬ë¶€ë¥¼ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”.</div>
              </div>

              <!-- ë‚´ì¥ SVG(ì„ì‹œ) : ì›í•˜ë©´ ì‹¤ì œ PNGë¡œ êµì²´ ê°€ëŠ¥ -->
              <svg class="hero-art" viewBox="0 0 420 420" xmlns="http://www.w3.org/2000/svg" aria-label="kidney">
                <defs>
                  <linearGradient id="k1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="#ffb2a6"/>
                    <stop offset="0.5" stop-color="#e87d70"/>
                    <stop offset="1" stop-color="#c85a54"/>
                  </linearGradient>
                  <linearGradient id="k2" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="#ffd6b8"/>
                    <stop offset="1" stop-color="#f0b78e"/>
                  </linearGradient>
                </defs>
                <ellipse cx="240" cy="215" rx="120" ry="150" fill="url(#k1)"/>
                <path d="M160 120 C120 160,120 290,170 330 C225 375,335 335,345 245 C355 145,250 70,160 120 Z" fill="url(#k1)"/>
                <path d="M120 235 C95 245,85 275,100 295 C115 315,145 310,160 290" fill="none" stroke="#b14a45" stroke-width="18" stroke-linecap="round"/>
                <path d="M128 232 C95 245,88 280,105 300 C120 318,148 310,160 290" fill="none" stroke="#f7c9a2" stroke-width="10" stroke-linecap="round"/>
                <rect x="78" y="210" width="80" height="80" rx="36" fill="url(#k2)" opacity="0.95"/>
                <circle cx="210" cy="235" r="10" fill="#3b2d2b"/>
                <circle cx="250" cy="235" r="10" fill="#3b2d2b"/>
                <path d="M210 265 C225 280,240 280,255 265" fill="none" stroke="#3b2d2b" stroke-width="8" stroke-linecap="round"/>
              </svg>

              <svg class="sparkle" width="70" height="70" viewBox="0 0 24 24" fill="none">
                <path d="M12 2l1.2 6.2L19 9.4l-5.8 1.2L12 17l-1.2-6.4L5 9.4l5.8-1.2L12 2z" fill="rgba(255,255,255,.75)"/>
              </svg>
            </div>

            <div class="card">
              <div class="section-title">
                <h2>ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
                <small class="muted">1ë¶„ ë‚´ í™•ì¸</small>
              </div>

              <label>ì„±ë³„</label>
              <select id="gender0">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="male">ë‚¨ì„±</option>
                <option value="female">ì—¬ì„±</option>
              </select>

              <label>ë‚˜ì´</label>
              <input id="age0" type="number" min="18" max="120" placeholder="ì˜ˆ: 62" />

              <div class="actions no-print" style="margin-top:16px">
                <button class="btn primary" id="goStep1Btn" disabled>ê¸‰ì—¬ëŒ€ìƒ í™•ì¸</button>
              </div>

              <div class="hint" id="validHint0">ì„±ë³„ê³¼ ë‚˜ì´ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>

        <!-- STEP 1 : ì¶”ê°€ ì…ë ¥ (ìƒë‹¨ì— ì„±ë³„/ë‚˜ì´ ê³ ì • ìš”ì•½) -->
        <div id="step1" style="display:none;">
          <div class="fixed-summary no-print">
            <div class="left">
              <span class="pill2" id="fixedSex">ì„±ë³„: â€”</span>
              <span class="pill2" id="fixedAge">ë‚˜ì´: â€”</span>
              <span class="pill2" style="background:rgba(200,16,46,.08);border-color:rgba(200,16,46,.18);color:#7f1d1d;">
                ì…ë ¥ê°’ì€ ê²°ê³¼ì— ë°˜ì˜ë©ë‹ˆë‹¤
              </span>
            </div>

            <!-- ìˆ˜ì • ê°€ëŠ¥(ê³ ì • í‘œì‹œ + í•„ìš” ì‹œ ë³€ê²½) -->
            <div class="edit">
              <div class="field">
                <label>ì„±ë³„(ìˆ˜ì •)</label>
                <select id="gender1">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="male">ë‚¨ì„±</option>
                  <option value="female">ì—¬ì„±</option>
                </select>
              </div>
              <div class="field">
                <label>ë‚˜ì´(ìˆ˜ì •)</label>
                <input id="age1" type="number" min="18" max="120" placeholder="ì˜ˆ: 62" />
              </div>
            </div>
          </div>

          <div class="grid">
            <div class="card" id="inputCard">
              <div class="section-title">
                <h2>ê²€ì‚¬ ìˆ˜ì¹˜</h2>
                <small class="muted">Scr, K</small>
              </div>

              <div class="row2">
                <div>
                  <label>í˜ˆì²­ í¬ë ˆì•„í‹°ë‹Œ (mg/dL)</label>
                  <input id="creatinine" type="number" step="0.1" placeholder="ì˜ˆ: 1.2" />
                  <div class="hint">ê°„ì´í‘œëŠ” í˜ˆì²­ í¬ë ˆì•„í‹°ë‹Œ ê¸°ì¤€</div>
                </div>
                <div>
                  <label>ì¹¼ë¥¨ (mmol/L)</label>
                  <input id="potassium" type="number" step="0.1" placeholder="ì˜ˆ: 4.5" />
                  <div class="hint">ì‹œì‘ ê¶Œì¥: â‰¤ 4.8</div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="section-title">
                <h2>ë‹¨ë°±ë‡¨/ì•Œë¶€ë¯¼ë‡¨</h2>
                <small class="muted">ë‘˜ ì¤‘ í•˜ë‚˜</small>
              </div>

              <label>ê²€ì‚¬ ë°©ë²•</label>
              <select id="proteinTest">
                <option value="dipstick">ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ (Dipstick)</option>
                <option value="uacr">uACR (ìš”ì•Œë¶€ë¯¼/í¬ë ˆì•„í‹°ë‹Œë¹„)</option>
              </select>

              <div id="dipstickWrap">
                <label>Dipstick ê²°ê³¼</label>
                <select id="dipstick">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="negative">ìŒì„± (-)</option>
                  <option value="trace">ì•½ì–‘ì„± (Â±)</option>
                  <option value="1plus">1+</option>
                  <option value="2plus">2+</option>
                  <option value="3plus">3+</option>
                </select>
              </div>

              <div id="uacrWrap" style="display:none;">
                <label>uACR (mg/g)</label>
                <input id="uacr" type="number" step="1" placeholder="ì˜ˆ: 350" />
              </div>
            </div>

            <div class="card">
              <div class="section-title">
                <h2>ì¶”ê°€ ì¡°ê±´</h2>
                <small class="muted">ê¸‰ì—¬ ê¸°ì¤€</small>
              </div>

              <label>ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ìì…ë‹ˆê¹Œ?</label>
              <select id="diabetes">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>

              <label>ACEì–µì œì œ ë˜ëŠ” ARBë¥¼ ìµœëŒ€í—ˆìš© ìš©ëŸ‰ìœ¼ë¡œ 4ì£¼ ì´ìƒ íˆ¬ì—¬ ì¤‘ì…ë‹ˆê¹Œ?</label>
              <select id="aceArb">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>

              <label>ë§Œì„± ì‹¬ë¶€ì „(NYHA class II~IV) í™˜ìì…ë‹ˆê¹Œ?</label>
              <select id="heartFailure">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="yes">ì˜ˆ</option>
                <option value="no">ì•„ë‹ˆì˜¤</option>
              </select>

              <div class="actions no-print">
                <button class="btn primary" id="goResultBtn" disabled>ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                <button class="btn" id="backToStartBtn">ì²˜ìŒìœ¼ë¡œ</button>
              </div>

              <div class="hint" id="validHint1">ëª¨ë“  í•„ìˆ˜ê°’ì„ ì…ë ¥í•˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>

        <!-- STEP 2 : ê²°ê³¼(ê¸°ì¡´ ë™ì¼) -->
        <div id="step2" style="display:none;">
          <div class="grid">
            <div class="card print-area">
              <div class="result-head">
                <div>
                  <div class="section-title" style="margin-bottom:6px">
                    <h2>íŒì • ê²°ê³¼</h2>
                    <small class="muted">ìš”ì•½ë¬¸ ìƒì„±</small>
                  </div>
                  <div id="resultBadge" class="badge">â€”</div>
                </div>
                <div class="actions no-print" style="margin:0">
                  <button class="btn soft" id="openReviewBtn">ì¹˜ë£Œ í›„ê¸° ë³´ê¸°</button>
                </div>
              </div>

              <div class="kpi">
                <div class="box">
                  <div class="k">ê³„ì‚°ëœ eGFR</div>
                  <div class="v" id="egfrView">â€”</div>
                  <div class="hint muted">mL/min/1.73ã¡</div>
                </div>
                <div class="box">
                  <div class="k">ìƒë³‘ì½”ë“œ(ì°¸ê³  í‘œê¸°)</div>
                  <div class="v" id="codeView">â€”</div>
                  <div class="hint muted">ê¸°ê´€/ì§„ë‹¨ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ</div>
                </div>
              </div>

              <div class="divider"></div>

              <div id="reasonWrap" style="display:none;">
                <div class="badge bad" style="margin-bottom:8px;">ì ìš© ë¶ˆê°€ ì‚¬ìœ </div>
                <ul id="reasons"></ul>
              </div>

              <div id="okWrap" style="display:none;">
                <div class="badge good" style="margin-bottom:8px;">ì¶©ì¡± ê¸°ì¤€</div>
                <ul id="oks"></ul>
              </div>

              <div class="actions no-print" style="margin-top:14px">
                <button class="btn" id="backToInputsBtn">ì…ë ¥ìœ¼ë¡œ</button>
              </div>
            </div>

            <div class="card print-area">
              <div class="header-with-action no-print">
                <div class="left">
                  <h2 style="margin:0;font-size:16px;letter-spacing:-.01em">ì¶œë ¥/ë³µì‚¬</h2>
                  <small class="muted">íƒ­ìœ¼ë¡œ ë¶„ë¦¬</small>
                </div>
                <button class="btn danger btn-reset" id="newBtn">ìƒˆë¡œ ê²€ì‚¬í•˜ê¸°</button>
              </div>

              <div class="tabs no-print" role="tablist" aria-label="ê²°ê³¼ íƒ­">
                <button class="tab active" id="tabSummary" role="tab" aria-selected="true">ìš”ì•½ë¬¸</button>
                <button class="tab" id="tabCaution" role="tab" aria-selected="false">ì£¼ì˜ì‚¬í•­</button>
              </div>

              <div class="tabpanels">
                <div class="tabpanel active" id="panelSummary" role="tabpanel">
                  <label>ìš”ì•½ë¬¸</label>
                  <textarea id="summary" readonly></textarea>

                  <div class="actions no-print" style="margin-top:12px">
                    <button class="btn primary" id="copyBtn">ìš”ì•½ë¬¸ ë³µì‚¬</button>
                    <button class="btn" id="printSummaryBtn">ìš”ì•½ë¬¸ PDF í”„ë¦°íŠ¸</button>
                    <button class="btn" id="printAllBtn">ìš”ì•½+ì£¼ì˜ì‚¬í•­ PDF í”„ë¦°íŠ¸</button>
                  </div>

                  <div class="hint muted" style="margin-top:10px">
                    * ë³¸ ë„êµ¬ëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ì²˜ë°©/ê¸‰ì—¬ íŒë‹¨ì€ ì˜ë£Œì§„ì´ ì„ìƒì •ë³´ ë° í—ˆê°€ì‚¬í•­/ì‹¬ì‚¬ê¸°ì¤€ì— ë”°ë¼ ê²°ì •í•©ë‹ˆë‹¤.
                  </div>
                </div>

                <div class="tabpanel" id="panelCaution" role="tabpanel">
                  <div id="cautionBlock" class="print-area">
                    <div class="section-title" style="margin-bottom:6px">
                      <h2>í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­</h2>
                      <small class="muted">PDF ì¶œë ¥ ê°€ëŠ¥</small>
                    </div>

                    <div class="caution-text" style="font-size:13px;line-height:1.55;color:#111827">
                      <strong>í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­:</strong><br/>
                      - ì¼€ë Œë””ì•„(Finerenone)ëŠ” ì‹ ì¥ ë³´í˜¸ ë° ì‹¬í˜ˆê´€ ì§ˆí™˜ ì˜ˆë°©ì„ ìœ„í•œ ì•½ì œë¡œ,
                      2í˜• ë‹¹ë‡¨ë³‘ê³¼ ë§Œì„±ì‹ ì¥ë³‘(CKD) í™˜ìì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.<br/><br/>

                      - ë³µìš© ì¤‘ ê³ ì¹¼ë¥¨í˜ˆì¦ì˜ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br/>
                      - ê³ ì¹¼ë¥¨í˜ˆì¦ ì¦ìƒ: ê·¼ìœ¡ ì•½í™”, í”¼ë¡œê°, ë¬´ê¸°ë ¥, ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê±°ë‚˜ ëŠë ¤ì§€ëŠ” ëŠë‚Œ(ë¶€ì •ë§¥)<br/>
                      &nbsp;&nbsp;ì´ëŸ¬í•œ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ë©´ ì¦‰ì‹œ ì˜ë£Œì§„ì—ê²Œ ì•Œë¦¬ì‹­ì‹œì˜¤.<br/>
                      - ê³ í˜ˆì••ì•½(RAASì–µì œì œ)ê³¼ ë³‘ìš© ì‹œ ì „í•´ì§ˆ ì´ìƒì„ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•©ë‹ˆë‹¤.<br/>
                      - ì´ìƒ ì¦ìƒ ì‹œ ì¦‰ì‹œ ì˜ë£Œì§„ì— ìƒë‹´í•˜ì„¸ìš”.<br/>
                      - ì˜ì‚¬ ì§€ì‹œ ì—†ì´ ë³µìš©ì„ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì¦ëŸ‰í•˜ì§€ ë§ˆì„¸ìš”.<br/><br/>

                      âœ” CKD í™˜ìëŠ” ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ë¡œ í˜ˆì¤‘ ì¹¼ë¥¨ ë†ë„ë¥¼ í™•ì¸í•˜ê³ , ì¹¼ë¥¨ ì„­ì·¨ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.<br/><br/>

                      ğŸ½ ì¹¼ë¥¨ ì„­ì·¨ë¥¼ ì¤„ì´ëŠ” ë°©ë²•:<br/>
                      &nbsp;1. ì•¼ì±„ëŠ” ë“ëŠ” ë¬¼ì— ë°ì¹˜ê¸° (ì±„ì†Œ ë¬´ê²Œì˜ 4~5ë°° ì´ìƒ ë¬¼ ì‚¬ìš©)<br/>
                      &nbsp;2. ì–‡ê²Œ ì¬ í›„ ì°¬ë¬¼ì— 2ì‹œê°„ ë‹´ê°”ë‹¤ê°€ ë¬¼ì„ ë²„ë¦¬ê³  ì¡°ë¦¬<br/>
                      &nbsp;3. ì±„ì†Œ ê»ì§ˆê³¼ ì¤„ê¸° ì œê±° í›„ ì„­ì·¨<br/><br/>

                      âš ï¸ ì¹¼ë¥¨ì´ ë§ì€ ì‹í’ˆ ì£¼ì˜:<br/>
                      - ê°ì, ê³ êµ¬ë§ˆ, í† ë§ˆí† , ë°”ë‚˜ë‚˜, í‚¤ìœ„, ë©œë¡ <br/>
                      - ì‹œê¸ˆì¹˜, ë¯¸ì—­, ë‹¤ì‹œë§ˆ, ì½©, ê²¬ê³¼ë¥˜<br/>
                      - ì´ˆì½œë¦¿, ì»¤í”¼, ë‘ìœ , ì£¼ìŠ¤, ì¸ìŠ¤í„´íŠ¸êµ­, í™ì‚¼ì ¤ë¦¬ ë“±<br/><br/>

                      ğŸ’§ ìˆ˜ë¶„ ì„­ì·¨ëŠ” ì‹ ì¥ ìƒíƒœì— ë”°ë¼ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì—¬ ê²°ì •í•˜ì„¸ìš”.<br/>
                      (ì¶œì²˜: CKD in T2D Awareness Symposium, Kerendia &amp; ì¢…ê·¼ë‹¹)
                    </div>

                    <div class="actions no-print" style="margin-top:12px">
                      <button class="btn" id="printCautionBtn">ì£¼ì˜ì‚¬í•­ PDF í”„ë¦°íŠ¸</button>
                      <button class="btn" id="printAllBtn2">ìš”ì•½+ì£¼ì˜ì‚¬í•­ PDF í”„ë¦°íŠ¸</button>
                    </div>

                    <div class="hint muted" style="margin-top:10px">
                      * ë³¸ ë„êµ¬ëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ì²˜ë°©/ê¸‰ì—¬ íŒë‹¨ì€ ì˜ë£Œì§„ì´ ì„ìƒì •ë³´ ë° í—ˆê°€ì‚¬í•­/ì‹¬ì‚¬ê¸°ì¤€ì— ë”°ë¼ ê²°ì •í•©ë‹ˆë‹¤.
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="ì¹˜ë£Œ í›„ê¸°">
    <div class="modal">
      <header>
        <strong>ì¹˜ë£Œ í›„ê¸°</strong>
        <button class="btn" id="closeModalBtn" style="padding:8px 10px">ë‹«ê¸°</button>
      </header>
      <div class="body">
        <img id="reviewImg" src="review.png?v=1" alt="ì¹˜ë£Œ í›„ê¸° ì´ë¯¸ì§€ (review.png)" />
        <div class="hint muted" style="margin-top:10px">
          ì´ë¯¸ì§€ê°€ ì•ˆ ë³´ì´ë©´ ê°™ì€ í´ë”ì— <b>review.png</b> íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Reset Modal -->
  <div class="modal-backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-label="ìƒˆë¡œ ê²€ì‚¬í•˜ê¸° í™•ì¸">
    <div class="modal confirm" role="document">
      <header>
        <strong>ìƒˆë¡œ ê²€ì‚¬í•˜ê¸°</strong>
        <button class="btn" id="closeConfirmBtn" style="padding:8px 10px">ë‹«ê¸°</button>
      </header>
      <div class="body">
        <p class="msg-title">ì…ë ¥ê°’ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
        <p class="msg-desc">
          í˜„ì¬ ì…ë ¥/ê³„ì‚°ëœ ë‚´ìš©ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ê³ , ì‹œì‘ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.<br/>
          ê³„ì† ì§„í–‰í• ê¹Œìš”?
        </p>
      </div>
      <div class="footer">
        <button class="btn ghost" id="cancelResetBtn">ì·¨ì†Œ</button>
        <button class="btn danger" id="confirmResetBtn">ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ê²€ì‚¬</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

  <script>
    const $ = (id)=>document.getElementById(id);
    let lastFocusEl = null;

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    function toNum(v){ const n = parseFloat(v); return Number.isFinite(n)? n : NaN; }
    function toInt(v){ const n = parseInt(v,10); return Number.isFinite(n)? n : NaN; }

    function formatLocalDateTime(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function setPrintHeader(title, sub){
      $("printDocTitle").textContent = title || "ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼";
      $("printDocSub").textContent = sub || "ìš”ì•½ë¬¸ ë° í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­";
      $("printTime").textContent = formatLocalDateTime(new Date());
    }

    // ---------------- Step control ----------------
    function setActiveChip(step){
      ["step0Chip","step1Chip","step2Chip"].forEach(id=>$(id).classList.remove("active"));
      $(step === 0 ? "step0Chip" : step === 1 ? "step1Chip" : "step2Chip").classList.add("active");
    }

    function goStep(step){
      $("step0").style.display = (step===0) ? "block" : "none";
      $("step1").style.display = (step===1) ? "block" : "none";
      $("step2").style.display = (step===2) ? "block" : "none";
      setActiveChip(step);
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ---------------- State (age/gender) ----------------
    function getGenderAge(){
      // step1 inputs are source of truth once step1 entered
      const g = $("gender1").value || $("gender0").value;
      const a = $("age1").value || $("age0").value;
      return {gender:g, age:a};
    }

    function syncGenderAgeToStep1(){
      $("gender1").value = $("gender0").value;
      $("age1").value = $("age0").value;
      updateFixedBar();
    }

    function updateFixedBar(){
      const {gender, age} = getGenderAge();
      const gText = gender === "male" ? "ë‚¨ì„±" : gender === "female" ? "ì—¬ì„±" : "â€”";
      const aText = age ? `${age}ì„¸` : "â€”";
      $("fixedSex").textContent = `ì„±ë³„: ${gText}`;
      $("fixedAge").textContent = `ë‚˜ì´: ${aText}`;
    }

    // ---------------- Validations ----------------
    function isValidStep0(){
      const g = $("gender0").value;
      const a = $("age0").value;
      return !!g && !!a;
    }

    function updateStep0UI(){
      const ok = isValidStep0();
      $("goStep1Btn").disabled = !ok;
      $("validHint0").textContent = ok
        ? "ì¤€ë¹„ ì™„ë£Œ! 'ê¸‰ì—¬ëŒ€ìƒ í™•ì¸'ì„ ëˆŒëŸ¬ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤."
        : "ì„±ë³„ê³¼ ë‚˜ì´ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    }

    function formStateStep1(){
      const {gender, age} = getGenderAge();
      return {
        gender,
        age,
        creatinine: $("creatinine").value,
        potassium: $("potassium").value,
        proteinTest: $("proteinTest").value,
        dipstick: $("dipstick").value,
        uacr: $("uacr").value,
        diabetes: $("diabetes").value,
        aceArb: $("aceArb").value,
        heartFailure: $("heartFailure").value
      };
    }

    function isValidStep1(){
      const f = formStateStep1();
      if(!f.gender || !f.age) return false;
      if(!f.creatinine || !f.potassium || !f.diabetes || !f.aceArb || !f.heartFailure) return false;
      if(f.proteinTest === "dipstick"){ if(!f.dipstick) return false; }
      else { if(!f.uacr) return false; }
      return true;
    }

    function updateStep1UI(){
      updateFixedBar();
      const ok = isValidStep1();
      $("goResultBtn").disabled = !ok;
      $("validHint1").textContent = ok
        ? "ì¤€ë¹„ ì™„ë£Œ! 'ê²°ê³¼ í™•ì¸í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤."
        : "ëª¨ë“  í•„ìˆ˜ê°’ì„ ì…ë ¥í•˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.";
    }

    // ---------------- Calculation ----------------
    // CKD-EPI Creatinine Equation (2021)
    function calcEGFR(gender, age, creatinine){
      const K = gender === "male" ? 0.9 : 0.7;
      const alpha = gender === "male" ? -0.302 : -0.241;
      const scr = toNum(creatinine);
      const ageNum = toInt(age);

      const min = Math.min(scr / K, 1);
      const max = Math.max(scr / K, 1);

      let egfr = 142 * Math.pow(min, alpha) * Math.pow(max, -1.200) * Math.pow(0.9938, ageNum);
      if(gender === "female") egfr *= 1.012;

      return Math.round(egfr);
    }

    function diseaseCodeFromEGFR(egfr){
      if(egfr >= 60 && egfr < 75) return "N182 (ë§Œì„±ì‹ ì¥ë³‘ 2ê¸°)";
      if(egfr >= 30 && egfr < 60) return "N183 (ë§Œì„±ì‹ ì¥ë³‘ 3ê¸°)";
      if(egfr >= 25 && egfr < 30) return "N184 (ë§Œì„±ì‹ ì¥ë³‘ 4ê¸°)";
      return "";
    }

    function buildResult(){
      const f = formStateStep1();
      const egfr = calcEGFR(f.gender, f.age, f.creatinine);

      let eligible = true;
      const reasons = [];
      const oks = [];

      if(f.diabetes !== "yes"){ eligible = false; reasons.push("ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ìê°€ ì•„ë‹™ë‹ˆë‹¤."); }
      else oks.push("ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ì");

      if(f.aceArb !== "yes"){ eligible = false; reasons.push("ACEì–µì œì œ ë˜ëŠ” ARBë¥¼ ìµœëŒ€í—ˆìš© ìš©ëŸ‰ìœ¼ë¡œ 4ì£¼ ì´ìƒ íˆ¬ì—¬ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."); }
      else oks.push("ACEì–µì œì œ ë˜ëŠ” ARB 4ì£¼ ì´ìƒ íˆ¬ì—¬ ì¤‘");

      if(egfr < 25){ eligible = false; reasons.push(`eGFR ${egfr} (25 ë¯¸ë§Œ) â†’ íˆ¬ì—¬ ì‹œì‘ ê¶Œì¥ ì•ˆ ë¨`); }
      else if(egfr >= 75){ eligible = false; reasons.push(`eGFR ${egfr} (75 ì´ìƒ)`); }
      else oks.push("eGFR 25 ì´ìƒ 75 ë¯¸ë§Œ");

      if(f.proteinTest === "dipstick"){
        if(!f.dipstick || f.dipstick === "negative" || f.dipstick === "trace"){
          eligible = false; reasons.push("ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ ê²°ê³¼ê°€ 1+ ë¯¸ë§Œì…ë‹ˆë‹¤.");
        }else oks.push("ë‹¨ë°±ë‡¨ ê¸°ì¤€ ì¶©ì¡± (Dipstick 1+ ì´ìƒ)");
      }else{
        const u = toNum(f.uacr);
        if(!Number.isFinite(u) || u <= 300){
          eligible = false; reasons.push("uACRì´ 300 mg/g ì´í•˜ì…ë‹ˆë‹¤.");
        }else oks.push("ì•Œë¶€ë¯¼ë‡¨ ê¸°ì¤€ ì¶©ì¡± (uACR > 300)");
      }

      const k = toNum(f.potassium);
      if(!Number.isFinite(k)){ eligible = false; reasons.push("ì¹¼ë¥¨ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); }
      else if(k > 4.8){ eligible = false; reasons.push(`ì¹¼ë¥¨ ${k} mmol/L (4.8 ì´ˆê³¼)`); }
      else oks.push("ì¹¼ë¥¨ 4.8 mmol/L ì´í•˜");

      if(f.heartFailure === "yes"){ eligible = false; reasons.push("ë§Œì„± ì‹¬ë¶€ì „(NYHA class II~IV)ì€ ê¸‰ì—¬ ê¸°ì¤€ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤."); }
      else oks.push("ë§Œì„± ì‹¬ë¶€ì „ ì—†ìŒ");

      if(egfr < 15){
        eligible = false;
        reasons.push(`eGFR ${egfr} (15 ë¯¸ë§Œ) â†’ íˆ¬ì—¬ ì¤‘ë‹¨ ê¸°ì¤€ êµ¬ê°„`);
      }

      const code = (egfr >= 25 && egfr < 75) ? (diseaseCodeFromEGFR(egfr) || "â€”") : "â€”";

      const sexKo = f.gender === "male" ? "ë‚¨" : "ì—¬";
      const proteinText = (f.proteinTest === "dipstick")
        ? `Dipstick: ${f.dipstick || "ë¯¸ì…ë ¥"}`
        : `uACR: ${f.uacr || "ë¯¸ì…ë ¥"} mg/g`;
      const dmText = f.diabetes === "yes" ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤";
      const aceText = f.aceArb === "yes" ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤";
      const hfText = f.heartFailure === "yes" ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤";

      const header = `ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ìš”ì•½`;
      const line1 = `- ê¸°ë³¸ì •ë³´: ì„±ë³„ ${sexKo}, ë‚˜ì´ ${f.age}ì„¸`;
      const line2 = `- ê²€ì‚¬: Scr ${f.creatinine} mg/dL, K ${f.potassium} mmol/L, ${proteinText}`;
      const line3 = `- ì¡°ê±´: ì œ2í˜• ë‹¹ë‡¨ ${dmText}, ACEi/ARB 4ì£¼ ì´ìƒ ${aceText}, ë§Œì„±ì‹¬ë¶€ì „(NYHA II~IV) ${hfText}`;
      const line4 = `- ê³„ì‚° eGFR: ${egfr} mL/min/1.73ã¡`;
      const line5 = `- ê²°ê³¼: ${eligible ? "ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥" : "ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€"}`;
      const line6 = `- ìƒë³‘ì½”ë“œ(ì°¸ê³ ): ${code}`;
      const line7 = (!eligible && reasons.length)
        ? `- ì ìš© ë¶ˆê°€ ì‚¬ìœ : ${reasons.join(" / ")}`
        : `- ì ìš© ê¸°ì¤€ ì¶©ì¡± í•­ëª©: ${oks.join(" / ")}`;

      const summary = [header,line1,line2,line3,line4,line5,line6,line7].join("\n");
      return {eligible, egfr, code, reasons, oks, summary};
    }

    function renderResult(r){
      $("egfrView").textContent = r.egfr;

      const rawCode = r.code || "â€”";
      $("codeView").innerHTML = (rawCode === "â€”") ? "â€”" : rawCode.replace(/\s*\(/, "<br>(");

      const badge = $("resultBadge");
      badge.className = "badge " + (r.eligible ? "good" : "bad");
      badge.textContent = r.eligible ? "âœ” ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥" : "âœ– ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€";

      $("reasons").innerHTML = "";
      $("oks").innerHTML = "";

      if(!r.eligible && r.reasons.length){
        $("reasonWrap").style.display = "block";
        $("okWrap").style.display = "none";
        r.reasons.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          $("reasons").appendChild(li);
        });
      }else{
        $("reasonWrap").style.display = "none";
        $("okWrap").style.display = "block";
        r.oks.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          $("oks").appendChild(li);
        });
      }

      $("summary").value = r.summary;
    }

    // ---------------- Print helpers ----------------
    function clearPrintModes(){
      document.body.classList.remove("print-summary-only","print-caution-only");
      window.onafterprint = null;
    }
    function printWithMode(mode){
      clearPrintModes();
      if(mode === "summary"){
        document.body.classList.add("print-summary-only");
        setPrintHeader("ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼", "ìš”ì•½ë¬¸ PDF ì¶œë ¥");
        toast("ìš”ì•½ë¬¸ PDF ì¶œë ¥: ì¸ì‡„ ì°½ì—ì„œ 'PDFë¡œ ì €ì¥'ì„ ì„ íƒí•˜ì„¸ìš”.");
      }else if(mode === "caution"){
        document.body.classList.add("print-caution-only");
        setPrintHeader("í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­", "ì£¼ì˜ì‚¬í•­ PDF ì¶œë ¥");
        toast("ì£¼ì˜ì‚¬í•­ PDF ì¶œë ¥: ì¸ì‡„ ì°½ì—ì„œ 'PDFë¡œ ì €ì¥'ì„ ì„ íƒí•˜ì„¸ìš”.");
      }else{
        setPrintHeader("ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼", "ìš”ì•½ë¬¸ + í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­");
        toast("ìš”ì•½+ì£¼ì˜ì‚¬í•­ PDF ì¶œë ¥: ì¸ì‡„ ì°½ì—ì„œ 'PDFë¡œ ì €ì¥'ì„ ì„ íƒí•˜ì„¸ìš”.");
      }
      setTimeout(()=>window.print(), 80);
      window.onafterprint = () => clearPrintModes();
    }

    // ---------------- Tabs ----------------
    function setTab(which){
      const isSummary = which === "summary";
      $("tabSummary").classList.toggle("active", isSummary);
      $("tabCaution").classList.toggle("active", !isSummary);
      $("tabSummary").setAttribute("aria-selected", String(isSummary));
      $("tabCaution").setAttribute("aria-selected", String(!isSummary));
      $("panelSummary").classList.toggle("active", isSummary);
      $("panelCaution").classList.toggle("active", !isSummary);
    }

    // ---------------- Modal helpers ----------------
    function openModal(backdropId, focusSelector){
      lastFocusEl = document.activeElement;
      const b = $(backdropId);
      b.classList.add("open");
      setTimeout(()=>{
        const focusEl = focusSelector ? b.querySelector(focusSelector) : null;
        (focusEl || b.querySelector("button") || b).focus?.();
      }, 0);
    }
    function closeModal(backdropId){
      const b = $(backdropId);
      b.classList.remove("open");
      setTimeout(()=>{ lastFocusEl?.focus?.(); }, 0);
    }

    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Escape") return;
      if($("confirmBackdrop").classList.contains("open")) closeModal("confirmBackdrop");
      else if($("modalBackdrop").classList.contains("open")) closeModal("modalBackdrop");
    });

    // ---------------- Events ----------------

    // Stepper navigation (safe)
    $("step0Chip").addEventListener("click", ()=>goStep(0));
    $("step1Chip").addEventListener("click", ()=>{
      if($("step1").style.display !== "none") goStep(1);
      else toast("ë¨¼ì € ì„±ë³„/ë‚˜ì´ë¥¼ ì…ë ¥í•˜ê³  ì§„í–‰í•˜ì„¸ìš”.");
    });
    $("step2Chip").addEventListener("click", ()=>{
      if($("step2").style.display !== "none") goStep(2);
      else toast("ë¨¼ì € ì…ë ¥ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    });

    // Step0 validation
    $("gender0").addEventListener("change", updateStep0UI);
    $("age0").addEventListener("input", updateStep0UI);

    $("goStep1Btn").addEventListener("click", ()=>{
      syncGenderAgeToStep1();
      goStep(1);
      setTimeout(()=>window.scrollTo({top:0,behavior:"smooth"}), 30);
      updateStep1UI();
    });

    // Step1: gender/age edit sync
    $("gender1").addEventListener("change", updateStep1UI);
    $("age1").addEventListener("input", updateStep1UI);

    // Protein test toggle
    $("proteinTest").addEventListener("change", (e)=>{
      const v = e.target.value;
      $("dipstickWrap").style.display = (v==="dipstick") ? "block" : "none";
      $("uacrWrap").style.display = (v==="uacr") ? "block" : "none";
      updateStep1UI();
    });

    // Step1 general validation update
    document.addEventListener("input", ()=>{
      if($("step1").style.display !== "none") updateStep1UI();
    });
    document.addEventListener("change", ()=>{
      if($("step1").style.display !== "none") updateStep1UI();
    });

    $("backToStartBtn").addEventListener("click", ()=>{
      goStep(0);
      updateStep0UI();
    });

    // Go result
    $("goResultBtn").addEventListener("click", ()=>{
      const r = buildResult();
      renderResult(r);
      goStep(2);
      setTab("summary");
    });

    $("backToInputsBtn").addEventListener("click", ()=>{
      goStep(1);
      updateStep1UI();
    });

    // Copy
    $("copyBtn").addEventListener("click", async ()=>{
      const text = $("summary").value;
      try{
        await navigator.clipboard.writeText(text);
        toast("ìš”ì•½ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(err){
        $("summary").select();
        document.execCommand("copy");
        toast("ìš”ì•½ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    });

    // Print
    $("printSummaryBtn").addEventListener("click", ()=>printWithMode("summary"));
    $("printCautionBtn").addEventListener("click", ()=>printWithMode("caution"));
    $("printAllBtn").addEventListener("click", ()=>printWithMode("all"));
    $("printAllBtn2").addEventListener("click", ()=>printWithMode("all"));

    // Review modal
    $("openReviewBtn").addEventListener("click", ()=>openModal("modalBackdrop", "#closeModalBtn"));
    $("closeModalBtn").addEventListener("click", ()=>closeModal("modalBackdrop"));
    $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")) closeModal("modalBackdrop"); });

    // Reset logic
    function resetAll(){
      // step0
      $("gender0").value = "";
      $("age0").value = "";

      // step1 gender/age
      $("gender1").value = "";
      $("age1").value = "";

      // step1 rest
      ["creatinine","potassium","uacr"].forEach(id=>$(id).value="");
      ["diabetes","aceArb","heartFailure","dipstick"].forEach(id=>$(id).value="");
      $("proteinTest").value = "dipstick";
      $("uacrWrap").style.display="none";
      $("dipstickWrap").style.display="block";

      updateFixedBar();
      updateStep0UI();
      updateStep1UI();
      goStep(0);
      toast("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // New exam confirm modal
    $("newBtn").addEventListener("click", ()=>openModal("confirmBackdrop", "#confirmResetBtn"));
    $("closeConfirmBtn").addEventListener("click", ()=>closeModal("confirmBackdrop"));
    $("cancelResetBtn").addEventListener("click", ()=>closeModal("confirmBackdrop"));
    $("confirmBackdrop").addEventListener("click", (e)=>{ if(e.target === $("confirmBackdrop")) closeModal("confirmBackdrop"); });
    $("confirmResetBtn").addEventListener("click", ()=>{
      closeModal("confirmBackdrop");
      resetAll();
    });

    // Init
    updateStep0UI();
    updateFixedBar();
    setPrintHeader("ì¼€ë Œë””ì•„ ê¸‰ì—¬ ì ìš© í™•ì¸ ê²°ê³¼", "ìš”ì•½ë¬¸ ë° í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­");
  </script>
</body>
</html>
