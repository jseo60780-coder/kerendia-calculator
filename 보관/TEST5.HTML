<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ê²°ê³¼ í™•ì¸ í”Œë¡œìš° (ë©€í‹°ìŠ¤í…)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --text:#111827; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb;
      --primary:#f59e0b; --primary2:#fb923c; /* ì˜¤ë Œì§€ í†¤ */
      --shadow: 0 18px 60px rgba(17,24,39,0.14);
      --radius: 22px;
      --okbg:#ecfdf5; --ok:#065f46;
      --nobg:#fef2f2; --no:#991b1b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 20% 25%, rgba(255,255,255,0.75), transparent),
        radial-gradient(900px 500px at 85% 18%, rgba(255,255,255,0.55), transparent),
        radial-gradient(800px 500px at 90% 90%, rgba(255,255,255,0.35), transparent),
        linear-gradient(180deg, #ffe8d1 0%, #ffb45f 50%, #ff8a00 100%);
      padding: 36px 18px;
    }

    .shell{
      max-width: 1080px;
      margin: 0 auto;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.55);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      padding: 20px 22px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 12px 30px rgba(245,158,11,0.35);
    }
    .sub{
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      white-space:nowrap;
    }

    .content{
      padding: 10px 22px 26px;
    }

    /* Stepper */
    .stepper{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:center;
      padding: 2px 0 16px;
    }
    .step{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width: 130px;
      position: relative;
      padding: 0 10px;
    }
    .dot{
      width: 26px; height: 26px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      font-size: 12px;
      border: 2px solid rgba(17,24,39,0.12);
      background: #fff;
      color: var(--muted);
    }
    .step.active .dot{
      border-color: rgba(245,158,11,0.55);
      box-shadow: 0 0 0 6px rgba(245,158,11,0.15);
      color: #111827;
    }
    .step.done .dot{
      border-color: rgba(6,95,70,0.25);
      background: rgba(236,253,245,0.85);
      color: #065f46;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .step.active .label{ color:#111827; }

    .line{
      position:absolute;
      top: 12px;
      left: 100%;
      width: 110px;
      height: 2px;
      background: rgba(17,24,39,0.10);
    }
    .step:last-child .line{ display:none; }
    .step.done .line{
      background: rgba(6,95,70,0.28);
    }

    /* Panels */
    .panel{
      display:none;
    }
    .panel.active{
      display:block;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: #fff;
      border: 1px solid rgba(229,231,235,0.9);
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(17,24,39,0.08);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(229,231,235,0.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(245,158,11,0.12), rgba(255,255,255,0));
    }
    .card-title{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,0.95);
      color: var(--muted);
      font-weight: 800;
      background: rgba(255,255,255,0.75);
      white-space:nowrap;
    }
    .card-body{ padding: 16px; }

    h1{
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:-0.5px;
    }
    .desc{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      font-weight: 600;
      line-height:1.6;
    }

    /* form */
    .section{ margin-top: 14px; }
    .sectionTitle{
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 900;
      color:#374151;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }

    label{
      display:block;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 800;
      color:#374151;
    }
    .field{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,0.95);
      outline:none;
      font-size: 14px;
      transition: box-shadow .15s, border-color .15s;
    }
    .field:focus{
      border-color: rgba(245,158,11,0.55);
      box-shadow: 0 0 0 6px rgba(245,158,11,0.14);
    }
    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      line-height:1.6;
    }

    .btn{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: none;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#111827;
      transition: transform .06s, opacity .15s;
    }
    .btn:hover{ opacity: 0.95; }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity: 0.55; cursor:not-allowed; }
    .btnGhost{
      background:#fff;
      border: 1px solid rgba(229,231,235,0.95);
      color:#111827;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .actions .btn{ flex:1; }
    .actions .btnGhost{ flex:1; }

    /* Result */
    .resultBox{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,0.95);
      background: #fff;
    }
    .status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .status h3{
      margin:0;
      font-size: 17px;
      font-weight: 900;
      letter-spacing:-0.4px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,0.08);
      white-space:nowrap;
    }
    .pill.ok{ background: var(--okbg); color: var(--ok); }
    .pill.no{ background: var(--nobg); color: var(--no); }

    .kpiItem{
      margin-top: 10px;
      background:#f9fafb;
      border: 1px solid rgba(229,231,235,0.9);
      border-radius: 14px;
      padding: 12px;
    }
    .kpiLabel{ margin:0 0 4px; font-size: 12px; color: var(--muted); font-weight: 800;}
    .kpiValue{ margin:0; font-size: 22px; font-weight: 900; letter-spacing:-0.4px; }
    .smallActions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 560px){ .smallActions{ grid-template-columns:1fr; } }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(229,231,235,0.95);
      display:none;
    }
    .toast.show{ display:block; }
    .toast.ok{ background: var(--okbg); color: var(--ok); }
    .toast.no{ background: var(--nobg); color: var(--no); }

    /* Modal */
    .modalOverlay{
      position: fixed; inset: 0;
      background: rgba(17,24,39,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(920px, 96vw);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      overflow:hidden;
      border: 1px solid rgba(229,231,235,0.8);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(229,231,235,0.85);
      background: linear-gradient(180deg, rgba(245,158,11,0.18), rgba(255,255,255,0));
    }
    .modalTitle{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .modalClose{
      border: none;
      background:#111827;
      color:#fff;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .modalBody{ padding: 14px 16px 18px; }
    .modalBody img{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,0.9);
      background:#f9fafb;
    }
    .modalHint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      font-weight: 700;
      white-space: pre-line;
    }

    /* Print summary only */
    #printArea{ display:none; }
    @media print{
      body{ background:#fff; padding:0; }
      .shell{ display:none !important; }
      #printArea{ display:block !important; padding: 16mm; }
      .printCard{
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 14px 14px;
        font-family:"Noto Sans KR", Arial, sans-serif;
        color:#111827;
      }
      .printTitle{
        font-size: 18px;
        font-weight: 900;
        margin: 0 0 8px;
      }
      .printMeta{
        font-size: 12px;
        color:#374151;
        margin: 0 0 10px;
        line-height: 1.6;
        white-space: pre-line;
      }
      .printSectionTitle{
        font-size: 13px;
        font-weight: 900;
        margin: 12px 0 6px;
      }
      .printText{
        font-size: 12px;
        line-height: 1.75;
        margin: 0;
        white-space: pre-line;
      }
      .printHr{
        height:1px;
        background:#e5e7eb;
        margin: 12px 0;
      }
    }
  </style>
</head>
<body>

<div class="shell">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div style="font-size:14px;">ê²°ê³¼ í™•ì¸ í”Œë¡œìš°</div>
        <div class="sub">ì˜ˆìœ ë©€í‹°ìŠ¤í… UI (ë‹¨ì¼ HTML)</div>
      </div>
    </div>
    <div class="sub">Demo v2</div>
  </div>

  <div class="content">
    <div class="stepper" id="stepper">
      <div class="step active" data-step="1">
        <div class="dot">1</div><div class="label">ê¸°ë³¸ ì…ë ¥</div><div class="line"></div>
      </div>
      <div class="step" data-step="2">
        <div class="dot">2</div><div class="label">ê²°ê³¼ í™•ì¸</div><div class="line"></div>
      </div>
      <div class="step" data-step="3">
        <div class="dot">3</div><div class="label">ìš”ì•½/ì¶œë ¥</div>
      </div>
    </div>

    <!-- STEP 1 -->
    <section class="panel active" id="panel1">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ê¸°ë³¸ ì…ë ¥</h2>
            <span class="badge">í•„ìˆ˜ ì…ë ¥ í›„ ë‹¤ìŒ ë‹¨ê³„</span>
          </div>
          <div class="card-body">
            <h1>ê¸‰ì—¬/íŒì • ê²°ê³¼ í™•ì¸ ì¤€ë¹„</h1>
            <p class="desc">ì…ë ¥ê°’ì„ ì±„ìš°ê³  <b>â€œê¸‰ì—¬ ê²°ê³¼ í™•ì¸í•˜ê¸°â€</b>ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ í™”ë©´(ê²°ê³¼)ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>

            <div class="section">
              <div class="sectionTitle">ê¸°ë³¸ ì •ë³´</div>
              <div class="row">
                <div>
                  <label>ì„±ë³„</label>
                  <select class="field" id="gender">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                  </select>
                </div>
                <div>
                  <label>ë‚˜ì´</label>
                  <input class="field" type="number" id="age" placeholder="ì˜ˆ: 60">
                  <div class="hint">ì •ìˆ˜ ì…ë ¥ ê¶Œì¥</div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="sectionTitle">ê²€ì‚¬ ìˆ˜ì¹˜</div>
              <div class="row">
                <div>
                  <label>í˜ˆì²­ í¬ë ˆì•„í‹°ë‹Œ (mg/dL)</label>
                  <input class="field" type="number" id="creatinine" step="0.1" placeholder="ì˜ˆ: 1.2">
                </div>
                <div>
                  <label>ì¹¼ë¥¨ (mmol/L)</label>
                  <input class="field" type="number" id="potassium" step="0.1" placeholder="ì˜ˆ: 4.5">
                </div>
              </div>
            </div>

            <div class="section">
              <div class="sectionTitle">ë‹¨ë°±ë‡¨/ì•Œë¶€ë¯¼ë‡¨</div>
              <div class="row">
                <div>
                  <label>ê²€ì‚¬ ë°©ë²•</label>
                  <select class="field" id="proteinTest" onchange="toggleProteinInputs()">
                    <option value="dipstick">ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ (Dipstick)</option>
                    <option value="uacr">uACR (mg/g)</option>
                  </select>
                </div>
                <div id="dipstickWrap">
                  <label>Dipstick ê²°ê³¼</label>
                  <select class="field" id="dipstick">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="negative">ìŒì„± (-)</option>
                    <option value="trace">ì•½ì–‘ì„± (Â±)</option>
                    <option value="1plus">1+</option>
                    <option value="2plus">2+</option>
                    <option value="3plus">3+</option>
                  </select>
                </div>
                <div id="uacrWrap" style="display:none;">
                  <label>uACR (mg/g)</label>
                  <input class="field" type="number" id="uacr" step="0.1" placeholder="ì˜ˆ: 350">
                </div>
              </div>
              <div class="hint">Dipstickì€ 1+ ì´ìƒ, uACRì€ 300 mg/g ì´ˆê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²´í¬í•©ë‹ˆë‹¤.</div>
            </div>

            <div class="section">
              <div class="sectionTitle">ì¶”ê°€ ì¡°ê±´</div>
              <div class="row">
                <div>
                  <label>ì œ2í˜• ë‹¹ë‡¨ë³‘</label>
                  <select class="field" id="diabetes">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="yes">ì˜ˆ</option>
                    <option value="no">ì•„ë‹ˆì˜¤</option>
                  </select>
                </div>
                <div>
                  <label>ACEì–µì œì œ/ARB 4ì£¼ ì´ìƒ</label>
                  <select class="field" id="aceArb">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="yes">ì˜ˆ</option>
                    <option value="no">ì•„ë‹ˆì˜¤</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:12px;">
                <div>
                  <label>ë§Œì„± ì‹¬ë¶€ì „ (NYHA II~IV)</label>
                  <select class="field" id="heartFailure">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="yes">ì˜ˆ</option>
                    <option value="no">ì•„ë‹ˆì˜¤</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn" onclick="goToResult()">ê¸‰ì—¬ ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
              <button class="btn btnGhost" onclick="resetAll()">ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ì•ˆë‚´</h2>
            <span class="badge">Step 1</span>
          </div>
          <div class="card-body">
            <h1 style="font-size:18px;">ì´ í™”ë©´ì€ â€œê°€ì…í¼â€ ìŠ¤íƒ€ì¼</h1>
            <p class="desc">ì…ë ¥ â†’ ê²°ê³¼ â†’ ìš”ì•½/ì¶œë ¥ìœ¼ë¡œ íë¦„ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>

            <div class="kpiItem" style="margin-top:12px;">
              <p class="kpiLabel">ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì œê³µ</p>
              <p class="kpiValue" style="font-size:16px;">ì ìš© ê°€ëŠ¥/ë¶ˆê°€, ìš”ì•½, ë³µì‚¬, PDF</p>
              <div class="hint">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ â€œí˜ì´ì§€ ì´ë™â€ì²˜ëŸ¼ ì „í™˜ë©ë‹ˆë‹¤.</div>
            </div>

            <div class="kpiItem" style="margin-top:10px;">
              <p class="kpiLabel">íŒ</p>
              <div class="desc" style="margin-top:6px;">
                â€¢ ìƒ‰/í°íŠ¸/ì—¬ë°± í†µì¼ = ì›¹ì‚¬ì´íŠ¸ ëŠë‚Œ í•µì‹¬<br/>
                â€¢ Stepper(ì§„í–‰ë°”) = â€œì œí’ˆâ€ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨<br/>
                â€¢ ê²°ê³¼ì— ì•¡ì…˜(ë³µì‚¬/PDF/í›„ê¸°) = ì‹¤ì‚¬ìš© ê°ì„±
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="panel" id="panel2">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ê²°ê³¼ í™•ì¸</h2>
            <span class="badge">Step 2</span>
          </div>
          <div class="card-body">
            <h1>íŒì • ê²°ê³¼</h1>
            <p class="desc">ì…ë ¥ê°’ ê¸°ë°˜ìœ¼ë¡œ eGFR ê³„ì‚° ë° ì ìš© ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>

            <div id="result" class="resultBox" style="margin-top:14px;">
              <div class="status">
                <h3>ëŒ€ê¸° ì¤‘</h3>
                <span class="pill">ê³„ì‚° ì „</span>
              </div>
              <div class="kpiItem">
                <p class="kpiLabel">ì•ˆë‚´</p>
                <p class="desc" style="margin:0;">Step 1ì—ì„œ ê°’ì„ ì…ë ¥í•œ ë’¤ ì´ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ì˜¤ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
              </div>
            </div>

            <div class="actions">
              <button class="btn btnGhost" onclick="goStep(1)">ì´ì „</button>
              <button class="btn" onclick="goStep(3)">ìš”ì•½/ì¶œë ¥ìœ¼ë¡œ</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ë¹ ë¥¸ ì•¡ì…˜</h2>
            <span class="badge">Step 2</span>
          </div>
          <div class="card-body">
            <div class="smallActions">
              <button class="btn btnGhost" id="btnReview" onclick="openReviewModal()" disabled>ì¹˜ë£Œ í›„ê¸°</button>
              <button class="btn btnGhost" id="btnCopy" onclick="copySummary()" disabled>ìš”ì•½ ë³µì‚¬</button>
              <button class="btn" id="btnPdf" onclick="printSummaryOnly()" disabled>ìš”ì•½ PDF</button>
            </div>
            <div id="toast" class="toast"></div>

            <div class="kpiItem">
              <p class="kpiLabel">ìš”ì•½ ë¯¸ë¦¬ë³´ê¸°</p>
              <p id="summaryPreview" class="desc" style="margin:0;white-space:pre-line;"></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="panel" id="panel3">
      <div class="grid">
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ìš”ì•½/ì¶œë ¥</h2>
            <span class="badge">Step 3</span>
          </div>
          <div class="card-body">
            <h1>ì˜ì‚¬ ì „ë‹¬ìš© ìš”ì•½</h1>
            <p class="desc">ì•„ë˜ ìš”ì•½ë¬¸ì€ ë³µì‚¬í•´ì„œ ë‹¤ë¥¸ ì‹œìŠ¤í…œ(EMR/ë©”ëª¨ ë“±)ì— ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <div class="kpiItem" style="margin-top:14px;">
              <p class="kpiLabel">ìš”ì•½ë¬¸</p>
              <pre id="summaryFull" style="margin:0;white-space:pre-wrap;font-family:inherit;font-size:13px;line-height:1.75;font-weight:700;"></pre>
            </div>

            <div class="actions">
              <button class="btn btnGhost" onclick="goStep(2)">ì´ì „</button>
              <button class="btn btnGhost" onclick="copySummary()">ìš”ì•½ë¬¸ ë³µì‚¬</button>
              <button class="btn" onclick="printSummaryOnly()">ìš”ì•½ë¬¸ PDF/í”„ë¦°íŠ¸</button>
            </div>

            <div class="kpiItem" style="margin-top:12px;">
              <p class="kpiLabel">í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­(ë¯¸ë¦¬ë³´ê¸°)</p>
              <div class="desc" style="white-space:pre-line;margin-top:6px;" id="precautionsPreview"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h2 class="card-title">ìœ í‹¸ë¦¬í‹°</h2>
            <span class="badge">Step 3</span>
          </div>
          <div class="card-body">
            <div class="actions" style="margin-top:0;">
              <button class="btn btnGhost" onclick="resetAll()">ìƒˆë¡œ ì‹œì‘</button>
              <button class="btn btnGhost" onclick="openReviewModal()">ì¹˜ë£Œ í›„ê¸° ë³´ê¸°</button>
            </div>

            <div class="kpiItem">
              <p class="kpiLabel">ë©”ëª¨</p>
              <p class="desc" style="margin:0;">
                â€¢ Step 2/3ëŠ” ê²°ê³¼ê°€ ìˆì–´ì•¼ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.<br/>
                â€¢ PDF ë²„íŠ¼ì€ â€œìš”ì•½ + ì£¼ì˜ì‚¬í•­â€ë§Œ ì¶œë ¥í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Modal -->
<div id="modalOverlay" class="modalOverlay" onclick="closeReviewModal(event)">
  <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <div class="modalHead">
      <h3 class="modalTitle">ì¹˜ë£Œ í›„ê¸°</h3>
      <button class="modalClose" onclick="closeReviewModal()">ë‹«ê¸°</button>
    </div>
    <div class="modalBody">
      <img src="treatment_review.png" alt="ì¹˜ë£Œ í›„ê¸° ì´ë¯¸ì§€">
      <div class="modalHint">ì´ë¯¸ì§€ëŠ” HTMLê³¼ ê°™ì€ í´ë”ì— "treatment_review.png"ë¡œ ë„£ì–´ì£¼ì„¸ìš”.</div>
    </div>
  </div>
</div>

<!-- Print only -->
<div id="printArea">
  <div class="printCard">
    <div class="printTitle">ê²°ê³¼ ìš”ì•½(ì¶œë ¥)</div>
    <div id="printMeta" class="printMeta"></div>
    <div class="printHr"></div>
    <div class="printSectionTitle">ìš”ì•½ë¬¸</div>
    <p id="printSummary" class="printText"></p>
    <div class="printHr"></div>
    <div class="printSectionTitle">í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­</div>
    <p id="printPrecautions" class="printText"></p>
  </div>
</div>

<script>
  const el = (id) => document.getElementById(id);
  let lastResult = null;

  const PRECAUTIONS_TEXT =
`í™˜ì ë³µìš© ì£¼ì˜ì‚¬í•­:
- ì¼€ë Œë””ì•„(Finerenone)ëŠ” ì‹ ì¥ ë³´í˜¸ ë° ì‹¬í˜ˆê´€ ì§ˆí™˜ ì˜ˆë°©ì„ ìœ„í•œ ì•½ì œë¡œ,
  2í˜• ë‹¹ë‡¨ë³‘ê³¼ ë§Œì„±ì‹ ì¥ë³‘(CKD) í™˜ìì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

- ë³µìš© ì¤‘ ê³ ì¹¼ë¥¨í˜ˆì¦ì˜ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
- ê³ ì¹¼ë¥¨í˜ˆì¦ ì¦ìƒ: ê·¼ìœ¡ ì•½í™”, í”¼ë¡œê°, ë¬´ê¸°ë ¥, ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê±°ë‚˜ ëŠë ¤ì§€ëŠ” ëŠë‚Œ(ë¶€ì •ë§¥)
  ì´ëŸ¬í•œ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ë©´ ì¦‰ì‹œ ì˜ë£Œì§„ì—ê²Œ ì•Œë¦¬ì‹­ì‹œì˜¤.
- ê³ í˜ˆì••ì•½(RAASì–µì œì œ)ê³¼ ë³‘ìš© ì‹œ ì „í•´ì§ˆ ì´ìƒì„ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•©ë‹ˆë‹¤.
- ì´ìƒ ì¦ìƒ ì‹œ ì¦‰ì‹œ ì˜ë£Œì§„ì— ìƒë‹´í•˜ì„¸ìš”.
- ì˜ì‚¬ ì§€ì‹œ ì—†ì´ ë³µìš©ì„ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì¦ëŸ‰í•˜ì§€ ë§ˆì„¸ìš”.

âœ” CKD í™˜ìëŠ” ì •ê¸°ì ì¸ í˜ˆì•¡ê²€ì‚¬ë¡œ í˜ˆì¤‘ ì¹¼ë¥¨ ë†ë„ë¥¼ í™•ì¸í•˜ê³ , ì¹¼ë¥¨ ì„­ì·¨ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.

ğŸ½ ì¹¼ë¥¨ ì„­ì·¨ë¥¼ ì¤„ì´ëŠ” ë°©ë²•:
 1. ì•¼ì±„ëŠ” ë“ëŠ” ë¬¼ì— ë°ì¹˜ê¸° (ì±„ì†Œ ë¬´ê²Œì˜ 4~5ë°° ì´ìƒ ë¬¼ ì‚¬ìš©)
 2. ì–‡ê²Œ ì¬ í›„ ì°¬ë¬¼ì— 2ì‹œê°„ ë‹´ê°”ë‹¤ê°€ ë¬¼ì„ ë²„ë¦¬ê³  ì¡°ë¦¬
 3. ì±„ì†Œ ê»ì§ˆê³¼ ì¤„ê¸° ì œê±° í›„ ì„­ì·¨

âš ï¸ ì¹¼ë¥¨ì´ ë§ì€ ì‹í’ˆ ì£¼ì˜:
 - ê°ì, ê³ êµ¬ë§ˆ, í† ë§ˆí† , ë°”ë‚˜ë‚˜, í‚¤ìœ„, ë©œë¡ 
 - ì‹œê¸ˆì¹˜, ë¯¸ì—­, ë‹¤ì‹œë§ˆ, ì½©, ê²¬ê³¼ë¥˜
 - ì´ˆì½œë¦¿, ì»¤í”¼, ë‘ìœ , ì£¼ìŠ¤, ì¸ìŠ¤í„´íŠ¸êµ­, í™ì‚¼ì ¤ë¦¬ ë“±

ğŸ’§ ìˆ˜ë¶„ ì„­ì·¨ëŠ” ì‹ ì¥ ìƒíƒœì— ë”°ë¼ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì—¬ ê²°ì •í•˜ì„¸ìš”.
(ì¶œì²˜: CKD in T2D Awareness Symposium, Kerendia & ì¢…ê·¼ë‹¹)`;

  el('precautionsPreview').textContent = PRECAUTIONS_TEXT;

  function setStepUI(step){
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    el('panel'+step).classList.add('active');

    document.querySelectorAll('.step').forEach(s=>{
      const n = parseInt(s.getAttribute('data-step'),10);
      s.classList.remove('active','done');
      if(n < step) s.classList.add('done');
      if(n === step) s.classList.add('active');
    });
  }

  function goStep(step){
    if(step === 2 && !lastResult){
      // Step2ëŠ” ê²°ê³¼ ì—†ì´ë„ ë³¼ ìˆ˜ ìˆì§€ë§Œ, UXìƒ ì•ˆë‚´
      showToast('Step 1ì—ì„œ â€œê¸‰ì—¬ ê²°ê³¼ í™•ì¸í•˜ê¸°â€ë¥¼ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”.', false);
    }
    if(step === 3 && !lastResult){
      showToast('ìš”ì•½/ì¶œë ¥ì€ ê²°ê³¼ ìƒì„± í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', false);
      return;
    }
    setStepUI(step);
    if(step === 3 && lastResult){
      el('summaryFull').textContent = buildSummaryText(lastResult);
    }
  }

  function toggleProteinInputs(){
    const mode = el('proteinTest').value;
    el('dipstickWrap').style.display = mode === 'dipstick' ? 'block' : 'none';
    el('uacrWrap').style.display = mode === 'uacr' ? 'block' : 'none';
  }

  function calculateEGFR(gender, age, creatinine) {
    const K = gender === 'male' ? 0.9 : 0.7;
    const alpha = gender === 'male' ? -0.302 : -0.241;
    const min = Math.min(creatinine / K, 1);
    const max = Math.max(creatinine / K, 1);
    let eGFR = 142 * Math.pow(min, alpha) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
    if (gender === 'female') eGFR *= 1.012;
    return Math.round(eGFR);
  }

  function goToResult(){
    const res = computeResult();
    lastResult = res;
    renderResult(res);
    enableActions(true);

    // Step2ë¡œ ì´ë™
    setStepUI(2);

    // Step3 ìš”ì•½ ì¤€ë¹„
    el('summaryFull').textContent = buildSummaryText(res);

    // ë¯¸ë¦¬ë³´ê¸°
    el('summaryPreview').textContent = buildSummaryText(res);
    showToast('ê²°ê³¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ìš”ì•½ ë³µì‚¬/PDF ê°€ëŠ¥)', true);
  }

  function computeResult(){
    const gender = el('gender').value;
    const age = parseInt(el('age').value, 10);
    const creatinine = parseFloat(el('creatinine').value);
    const potassium = parseFloat(el('potassium').value);
    const diabetes = el('diabetes').value;
    const aceArb = el('aceArb').value;
    const heartFailure = el('heartFailure').value;
    const proteinTest = el('proteinTest').value;
    const dipstick = el('dipstick').value;
    const uacrRaw = el('uacr').value;
    const uacr = uacrRaw === '' ? NaN : parseFloat(uacrRaw);

    let missing = [];
    if(!gender) missing.push('ì„±ë³„');
    if(!Number.isFinite(age)) missing.push('ë‚˜ì´');
    if(!Number.isFinite(creatinine)) missing.push('í¬ë ˆì•„í‹°ë‹Œ');
    if(!Number.isFinite(potassium)) missing.push('ì¹¼ë¥¨');
    if(!diabetes) missing.push('ë‹¹ë‡¨ë³‘ ì—¬ë¶€');
    if(!aceArb) missing.push('ACE/ARB');
    if(!heartFailure) missing.push('ì‹¬ë¶€ì „ ì—¬ë¶€');
    if(proteinTest === 'dipstick' && !dipstick) missing.push('Dipstick ê²°ê³¼');
    if(proteinTest === 'uacr' && !Number.isFinite(uacr)) missing.push('uACR');

    let eligible = true;
    let reasons = [];
    let diseaseCode = '';
    let eGFR = null;

    if(missing.length){
      eligible = false;
      reasons.push(`í•„ìˆ˜ ì…ë ¥ ëˆ„ë½: ${missing.join(', ')}`);
    } else {
      eGFR = calculateEGFR(gender, age, creatinine);

      if (diabetes !== 'yes') { eligible = false; reasons.push('ì œ2í˜• ë‹¹ë‡¨ë³‘ í™˜ìê°€ ì•„ë‹™ë‹ˆë‹¤'); }
      if (aceArb !== 'yes') { eligible = false; reasons.push('ACEì–µì œì œ ë˜ëŠ” ARBë¥¼ 4ì£¼ ì´ìƒ íˆ¬ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'); }

      if (eGFR < 25) {
        eligible = false;
        reasons.push(`eGFRì´ ${eGFR}ë¡œ 25 ë¯¸ë§Œì…ë‹ˆë‹¤ (íˆ¬ì—¬ ì‹œì‘ ê¶Œì¥ ì•ˆë¨)`);
      } else if (eGFR >= 75) {
        eligible = false;
        reasons.push(`eGFRì´ ${eGFR}ë¡œ 75 ì´ìƒì…ë‹ˆë‹¤`);
      } else {
        if (eGFR >= 60 && eGFR < 75) diseaseCode = 'N182 (ë§Œì„±ì‹ ì¥ë³‘ 2ê¸°)';
        else if (eGFR >= 30 && eGFR < 60) diseaseCode = 'N183 (ë§Œì„±ì‹ ì¥ë³‘ 3ê¸°)';
        else if (eGFR >= 25 && eGFR < 30) diseaseCode = 'N184 (ë§Œì„±ì‹ ì¥ë³‘ 4ê¸°)';
      }

      if (proteinTest === 'dipstick') {
        if (dipstick === 'negative' || dipstick === 'trace') {
          eligible = false;
          reasons.push('ìš” ì‹œí—˜ì§€ë´‰ ê²€ì‚¬ ê²°ê³¼ê°€ 1+ ë¯¸ë§Œì…ë‹ˆë‹¤');
        }
      } else {
        if (!Number.isFinite(uacr) || uacr <= 300) {
          eligible = false;
          reasons.push('uACRì´ 300 mg/g ì´í•˜ì…ë‹ˆë‹¤');
        }
      }

      if (potassium > 4.8) {
        eligible = false;
        reasons.push(`ì¹¼ë¥¨ ìˆ˜ì¹˜ê°€ ${potassium}ë¡œ 4.8 mmol/Lë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`);
      }

      if (heartFailure === 'yes') {
        eligible = false;
        reasons.push('ë§Œì„± ì‹¬ë¶€ì „(NYHA class II~IV) í™˜ìëŠ” ì œì™¸ë©ë‹ˆë‹¤');
      }
    }

    return {
      eligible, eGFR, diseaseCode, reasons,
      form:{ gender, age, creatinine, potassium, diabetes, aceArb, heartFailure, proteinTest, dipstick, uacr: (proteinTest==='uacr'? String(uacr) : '') }
    };
  }

  function renderResult(res){
    const title = res.eligible ? 'ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥' : 'ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€';
    const pillClass = res.eligible ? 'ok' : 'no';

    let html = `
      <div class="status">
        <h3>${title}</h3>
        <span class="pill ${pillClass}">${res.eligible ? 'Eligible' : 'Not eligible'}</span>
      </div>
      <div class="kpiItem">
        <p class="kpiLabel">ê³„ì‚°ëœ eGFR</p>
        <p class="kpiValue">${res.eGFR ?? '-'} <span style="font-size:12px;color:var(--muted);font-weight:800;">mL/min/1.73ã¡</span></p>
      </div>
    `;

    if(res.diseaseCode){
      html += `
        <div class="kpiItem" style="background:#eff6ff;">
          <p class="kpiLabel">ìƒë³‘ì½”ë“œ</p>
          <p class="desc" style="margin:0;font-weight:900;color:#1e40af;">${escapeHtml(res.diseaseCode)}</p>
        </div>
      `;
    }

    html += `
      <div class="kpiItem">
        <p class="kpiLabel">ê²°ê³¼ ìš”ì•½</p>
        <p class="desc" style="margin:0;white-space:pre-line;font-weight:700;">${escapeHtml(buildSummaryText(res))}</p>
      </div>
    `;

    if(!res.eligible && res.reasons && res.reasons.length){
      html += `
        <div class="kpiItem" style="background:var(--nobg);border-color: rgba(153,27,27,0.15);">
          <p class="kpiLabel" style="color:var(--no);font-weight:900;">ì ìš© ë¶ˆê°€ ì‚¬ìœ </p>
          <div class="desc" style="white-space:pre-line;margin:0;font-weight:700;">${escapeHtml(res.reasons.join('\n'))}</div>
        </div>
      `;
    }

    el('result').innerHTML = html;
  }

  function buildSummaryText(res){
    const f = res.form || {};
    const sex = (f.gender === 'male') ? 'ë‚¨ì„±' : (f.gender === 'female' ? 'ì—¬ì„±' : '-');
    const proteinLine = (f.proteinTest === 'uacr')
      ? `ì•Œë¶€ë¯¼ë‡¨: uACR ${f.uacr || '-'} mg/g`
      : `ë‹¨ë°±ë‡¨: Dipstick ${mapDipstick(f.dipstick)}`;

    let lines = [];
    lines.push(`íŒì •: ${res.eligible ? 'ì¼€ë Œë””ì•„ ì ìš© ê°€ëŠ¥' : 'ì¼€ë Œë””ì•„ ì ìš© ë¶ˆê°€'}`);
    lines.push(`eGFR: ${res.eGFR ?? '-'} mL/min/1.73ã¡${res.diseaseCode ? ` / ${res.diseaseCode}` : ''}`);
    lines.push(`ê¸°ë³¸: ${sex}, ${f.age || '-'}ì„¸ / Cr ${f.creatinine || '-'} mg/dL / K ${f.potassium || '-'} mmol/L`);
    lines.push(`${proteinLine}`);
    lines.push(`ì¡°ê±´: T2D ${yn(f.diabetes)} / ACEiÂ·ARB(â‰¥4ì£¼) ${yn(f.aceArb)} / ë§Œì„± ì‹¬ë¶€ì „ ${yn(f.heartFailure)}`);

    if(!res.eligible && res.reasons && res.reasons.length){
      const top = res.reasons.slice(0, 3).map((r, i) => `${i+1}) ${r}`);
      lines.push(`ë¶ˆê°€ ì‚¬ìœ : ${top.join(' / ')}${res.reasons.length > 3 ? ` (+${res.reasons.length - 3}ê°œ)` : ''}`);
    }
    return lines.join('\n');
  }

  function yn(v){ return v==='yes' ? 'ì˜ˆ' : (v==='no' ? 'ì•„ë‹ˆì˜¤' : '-'); }
  function mapDipstick(v){
    const m = {'negative':'ìŒì„±(-)','trace':'ì•½ì–‘ì„±(Â±)','1plus':'1+','2plus':'2+','3plus':'3+'};
    return m[v] || '-';
  }

  function enableActions(enabled){
    el('btnReview').disabled = !enabled;
    el('btnCopy').disabled = !enabled;
    el('btnPdf').disabled = !enabled;
  }

  async function copySummary(){
    if(!lastResult){ showToast('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. Step 1ì—ì„œ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”.', false); return; }
    const text = buildSummaryText(lastResult);
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
      } else {
        fallbackCopyText(text);
      }
      showToast('ìš”ì•½ë¬¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    } catch(e){
      fallbackCopyText(text);
      showToast('ë³µì‚¬ ê¶Œí•œ ë¬¸ì œë¡œ ëŒ€ì²´ ë°©ì‹ìœ¼ë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', true);
    }
  }

  function fallbackCopyText(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly','');
    ta.style.position = 'fixed';
    ta.style.top = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }

  function printSummaryOnly(){
    if(!lastResult){ showToast('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”.', false); return; }
    const now = new Date();
    const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    el('printMeta').textContent = `ìƒì„±ì¼ì‹œ: ${stamp}\në„êµ¬: ê²°ê³¼ í™•ì¸ í”Œë¡œìš°(ë‹¨ì¼ HTML ë°ëª¨)`;
    el('printSummary').textContent = buildSummaryText(lastResult);
    el('printPrecautions').textContent = PRECAUTIONS_TEXT;
    window.print();
  }

  function openReviewModal(){ el('modalOverlay').classList.add('show'); }
  function closeReviewModal(evt){
    if(evt && evt.target && evt.target.id !== 'modalOverlay') return;
    el('modalOverlay').classList.remove('show');
  }
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') el('modalOverlay').classList.remove('show'); });

  function showToast(msg, ok){
    const t = el('toast');
    t.textContent = msg;
    t.className = `toast show ${ok ? 'ok' : 'no'}`;
    setTimeout(()=>{ t.className = 'toast'; t.textContent = ''; }, 3200);
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function resetAll(){
    ['gender','age','creatinine','potassium','dipstick','uacr','diabetes','aceArb','heartFailure'].forEach(id=>{ if(el(id)) el(id).value=''; });
    el('proteinTest').value = 'dipstick';
    toggleProteinInputs();
    lastResult = null;
    enableActions(false);
    setStepUI(1);
    el('summaryPreview').textContent = '';
    el('summaryFull').textContent = '';
    const t = el('toast'); t.className='toast'; t.textContent='';
    el('result').innerHTML = `
      <div class="status">
        <h3>ëŒ€ê¸° ì¤‘</h3>
        <span class="pill">ê³„ì‚° ì „</span>
      </div>
      <div class="kpiItem">
        <p class="kpiLabel">ì•ˆë‚´</p>
        <p class="desc" style="margin:0;">Step 1ì—ì„œ ê°’ì„ ì…ë ¥í•œ ë’¤ ì´ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ì˜¤ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
      </div>
    `;
  }

  // init
  enableActions(false);
</script>

</body>
</html>
